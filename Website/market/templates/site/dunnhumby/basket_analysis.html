{% extends "site/base.html" %}
{% block title %}Comprehensive Market Basket Analysis | Analytics{% endblock %}

{% block extra_css %}
<style>
:root {
  --grocery-color: #2E86C1;
  --meat-color: #E74C3C;
  --dairy-color: #F39C12;
  --frozen-color: #85C1E9;
  --produce-color: #27AE60;
  --pharmacy-color: #8E44AD;
  --beverage-color: #17A2B8;
  --bakery-color: #D4AC0D;
  --seafood-color: #148F77;
  --deli-color: #FF6B6B;
  --floral-color: #FF69B4;
  --toys-color: #FF1493;
  --video-color: #9C27B0;
  --spirits-color: #795548;
  --default-color: #6C757D;
}

.module {
  max-width: 100%;
  overflow: visible;
  padding: 1rem;
}

.hero-section {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 3rem 2rem 2rem;
  border-radius: 25px;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
}

.hero-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" opacity="0.1"><circle cx="200" cy="200" r="3" fill="white"/><circle cx="800" cy="300" r="2" fill="white"/><circle cx="400" cy="600" r="2.5" fill="white"/><circle cx="700" cy="700" r="2" fill="white"/><circle cx="100" cy="800" r="3" fill="white"/></svg>');
  pointer-events: none;
}

.analysis-tabs {
  background: white;
  border-radius: 20px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  max-width: 100%;
}

.tab-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
  justify-content: center;
}

.tab-btn {
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #f8f9fa;
  color: #6c757d;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
}

.tab-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.tab-content {
  display: none;
  max-width: 100%;
  padding: 0;
}

.tab-content.active {
  display: block;
  animation: fadeInUp 0.5s ease;
}

.analysis-card, .analysis-type-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  border-left: 5px solid;
  position: relative;
  overflow: hidden;
  max-width: 100%;
}

.descriptive-card { border-left-color: #28a745; }
.predictive-card { border-left-color: #007bff; }
.differential-card { border-left-color: #dc3545; }

.basket-card, .product-card, .differential-insight-card {
  background: white;
  border-radius: 15px;
  padding: 1.5rem;
  height: 100%;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.basket-card:hover, .product-card:hover, .differential-insight-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.department-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 0.7rem;
  color: white;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 150px;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #2d3748;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.metric-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.metric-item {
  background: white;
  padding: 1.5rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.metric-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #667eea, #764ba2);
}

.metric-value {
  font-size: 1.8rem;
  font-weight: 800;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.metric-label {
  font-size: 0.8rem;
  color: #6c757d;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 0.5rem;
}

.chart-container {
  background: white;
  border-radius: 15px;
  padding: 1.2rem;
  margin: 1rem 0;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  max-width: 100%;
  overflow: hidden;
  border: 1px solid #e9ecef;
}

.recommendations-scroll-container {
  max-height: 420px;
  overflow-y: auto;
  padding-right: 0.75rem;
  margin-right: -0.25rem;
  padding-bottom: 0.5rem;
}

.recommendations-scroll-container::-webkit-scrollbar {
  width: 8px;
}

.recommendations-scroll-container::-webkit-scrollbar-thumb {
  background: rgba(102, 126, 234, 0.35);
  border-radius: 4px;
}

.recommendations-scroll-container::-webkit-scrollbar-track {
  background: rgba(248, 249, 250, 0.7);
}

.recommendation-card {
  border-radius: 20px;
  border: 2px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 15px 35px rgba(15, 23, 42, 0.12), 0 5px 15px rgba(0, 0, 0, 0.07);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 255, 0.95));
  backdrop-filter: blur(10px);
  border-image: linear-gradient(145deg, rgba(102, 126, 234, 0.3), rgba(67, 56, 202, 0.2)) 1;
  height: 100%;
  position: relative;
  overflow: hidden;
}

.recommendation-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 25px 50px rgba(99, 102, 241, 0.3), 0 10px 30px rgba(15, 23, 42, 0.15);
  border-color: rgba(99, 102, 241, 0.4);
}

.recommendation-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #667eea, #764ba2);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.recommendation-card:hover::before {
  opacity: 1;
}

.recommendation-card .card-body {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
  height: 100%;
  padding: 1.5rem;
  position: relative;
}

.recommendation-card .card-body::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 1.5rem;
  right: 1.5rem;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
}

.recommendation-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0.5rem;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.4rem;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 8px;
  border: 1px solid rgba(102, 126, 234, 0.1);
  transition: all 0.2s ease;
}

.meta-item:hover {
  background: rgba(102, 126, 234, 0.05);
  border-color: rgba(102, 126, 234, 0.2);
}

.meta-item i {
  width: 16px;
  text-align: center;
  font-size: 0.9rem;
}

.meta-item span {
  font-size: 0.85rem;
  color: #4a5568;
  font-weight: 500;
  margin-top: 0.25rem;
}

.recommendation-meta span {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.7rem;
  color: #6c757d;
}

.product-id-badge {
  background: rgba(15, 23, 42, 0.08);
  color: #1f2937;
  border-radius: 999px;
  font-size: 0.65rem;
  padding: 0.2rem 0.65rem;
  font-weight: 600;
  letter-spacing: 0.02em;
}

.recommendation-stat {
  background: rgba(237, 242, 247, 0.9);
  border-radius: 12px;
  padding: 0.5rem 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.75rem;
  color: #475569;
}

.recommendation-stat i {
  color: #6366f1;
}

.association-rules-container {
  padding: 1rem;
  border: 1px solid #e9ecef;
  border-radius: 10px;
  margin-top: 1rem;
}

.scrollable-section {
  border: 1px solid #e9ecef;
  border-radius: 10px;
  padding: 1rem;
}

.scrollable-section::-webkit-scrollbar {
  width: 6px;
}

.scrollable-section::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.scrollable-section::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 3px;
}

.scrollable-section::-webkit-scrollbar-thumb:hover {
  background: #5a67d8;
}

.rule-card {
  cursor: pointer;
  transition: all 0.3s ease;
}

.rule-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Enhanced popup interactivity */
#expandedContent .basket-card {
  cursor: pointer;
  transition: all 0.3s ease;
}

#expandedContent .basket-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  border-left: 4px solid #667eea;
}

#expandedContent .rule-card {
  cursor: pointer;
  transition: all 0.3s ease;
}

#expandedContent .rule-card:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  border-left-width: 6px;
}

.rule-card {
  background: white;
  border-radius: 10px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border-left: 4px solid #28a745;
  transition: all 0.3s ease;
  margin-bottom: 0.75rem;
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
}

.rule-card:hover {
  transform: translateX(5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.rule-arrow {
  display: inline-flex;
  align-items: center;
  margin: 0 0.5rem;
  color: #667eea;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.confidence-bar {
  background: #e9ecef;
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
  margin: 0.8rem 0;
}

.confidence-fill {
  height: 100%;
  background: linear-gradient(90deg, #28a745, #20c997);
  border-radius: 3px;
  transition: width 1s ease;
}

.interactive-controls {
  background: #f8f9fa;
  border-radius: 15px;
  padding: 1.5rem;
  margin: 1.5rem 0;
  max-width: 100%;
  overflow: hidden;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.control-label {
  font-weight: 600;
  color: #495057;
  min-width: 100px;
}

.control-slider {
  flex: 1;
  min-width: 200px;
  max-width: 300px;
}

.control-value {
  background: #667eea;
  color: white;
  padding: 0.3rem 0.8rem;
  border-radius: 10px;
  font-weight: 600;
  min-width: 60px;
  text-align: center;
}

.algorithm-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.insights-container {
  padding: 1rem;
  border: 1px solid #e9ecef;
  border-radius: 10px;
  margin-top: 1rem;
}

.fade-in {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .module {
    padding: 0.5rem;
  }
  
  .analysis-tabs {
    padding: 1rem;
  }
  
  .tab-buttons {
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }
  
  .tab-btn {
    width: 100%;
    justify-content: center;
    font-size: 0.8rem;
    padding: 0.6rem 1rem;
  }
  
  .algorithm-badge {
    font-size: 0.6rem;
    padding: 0.1rem 0.4rem;
  }
  
  .control-group {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .control-slider {
    width: 100%;
    min-width: auto;
    max-width: none;
  }
  
  .metric-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  
  .hero-section {
    padding: 1.5rem 1rem;
    margin-bottom: 1rem;
  }
  
  .hero-section h1 {
    font-size: 1.8rem !important;
  }
  
  .association-rules-container,
  .insights-container {
    padding: 0.8rem;
  }
  
  .chart-container {
    padding: 1rem;
  }
  
  .analysis-type-card {
    padding: 1rem;
    margin-bottom: 0.75rem;
  }
}

/* Custom scrollbar for containers */
.association-rules-container::-webkit-scrollbar,
.insights-container::-webkit-scrollbar {
  width: 6px;
}

.association-rules-container::-webkit-scrollbar-track,
.insights-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.association-rules-container::-webkit-scrollbar-thumb,
.insights-container::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 3px;
}

.tab-content.active {
  display: block;
}

/* Ensure natural scrolling */
html, body {
  overflow-x: hidden;
  overflow-y: auto;
}

* {
  box-sizing: border-box;
}

.row {
  margin-left: 0;
  margin-right: 0;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="module">
  <!-- Hero Section -->
  <div class="hero-section fade-in">
    <div class="text-center">
      <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">
        🛒 Advanced Market Basket Analysis
      </h1>
      <p style="font-size: 1.1rem; color: white !important; margin: 0;">
        Comprehensive data mining with Descriptive, Predictive & Differential Analysis
      </p>
    </div>
  </div>

  <!-- Analysis Tabs -->
  <div class="analysis-tabs fade-in">
    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab('descriptive')">
        <i class="fas fa-chart-bar"></i>
        Descriptive Analysis
        <span class="algorithm-badge">Apriori Algorithm</span>
      </button>
      <button class="tab-btn" onclick="switchTab('predictive')">
        <i class="fas fa-brain"></i>
        Predictive Analysis
        <span class="algorithm-badge">ML Algorithms</span>
      </button>
      <button class="tab-btn" onclick="switchTab('differential')">
        <i class="fas fa-balance-scale"></i>
        Differential Analysis
        <span class="algorithm-badge">Statistical Tests</span>
      </button>
    </div>

    <!-- Descriptive Analysis Tab -->
    <div id="descriptive" class="tab-content active">
      <div class="analysis-type-card descriptive-card">
        <h4 style="color: #28a745; margin-bottom: 1rem;">
          <i class="fas fa-search-plus"></i>
          Descriptive Market Basket Analysis
        </h4>
        <p style="color: #6c757d; line-height: 1.6; margin: 0;">
          Analyzes existing patterns and relationships in transaction data to understand customer behavior, 
          product associations, and optimal store layouts using Apriori algorithm.
        </p>
      </div>

      <!-- Interactive Controls -->
      <div class="interactive-controls">
        <h5><i class="fas fa-sliders-h"></i> Algorithm Parameters</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <div class="control-group">
              <label class="control-label">Min Support:</label>
              <input type="range" class="form-range control-slider" id="supportSlider" min="0.01" max="0.5" step="0.01" value="0.05">
              <span class="control-value" id="supportValue">0.05</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="control-group">
              <label class="control-label">Min Confidence:</label>
              <input type="range" class="form-range control-slider" id="confidenceSlider" min="0.1" max="1.0" step="0.01" value="0.6">
              <span class="control-value" id="confidenceValue">0.60</span>
            </div>
          </div>
        </div>
        <button class="btn btn-primary mt-2" onclick="runDescriptiveAnalysis()">
          <i class="fas fa-play"></i> Run Apriori Algorithm
        </button>
      </div>

      <!-- Key Metrics -->
      <div class="metric-grid">
        <div class="metric-item">
          <div class="metric-value" id="totalBaskets">114,156</div>
          <div class="metric-label">Total Baskets<br><small style="color: #6c757d; font-size: 0.6rem;">from 1M+ transactions</small></div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="avgBasketSize">9.2</div>
          <div class="metric-label">Avg Basket Size<br><small style="color: #6c757d; font-size: 0.6rem;">items per basket</small></div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="strongRules">0</div>
          <div class="metric-label">Strong Rules Found<br><small style="color: #6c757d; font-size: 0.6rem;">run algorithm to generate</small></div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="topLift">-</div>
          <div class="metric-label">Highest Lift<br><small style="color: #6c757d; font-size: 0.6rem;">measure of association</small></div>
        </div>
      </div>

      <!-- Association Rules -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0" id="deptRulesTitle"><i class="fas fa-project-diagram"></i> Association Rules (0/∞) — Department Level</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('department')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="association-rules-container scrollable-section" id="associationRules" style="max-height: 400px; overflow-y: auto;">
          <div class="text-center py-3 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Click "Run Apriori Algorithm" to generate association rules...</p>
          </div>
        </div>
      </div>

      <!-- Commodity-level Rules -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0" id="commodityRulesTitle"><i class="fas fa-boxes-stacked"></i> Association Rules (0/∞) — Commodity Level</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('commodity')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="association-rules-container scrollable-section" id="associationRulesCommodity" style="max-height: 400px; overflow-y: auto;">
          <div class="text-center py-3 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Click "Run Apriori Algorithm" to generate commodity-level rules...</p>
          </div>
        </div>
      </div>

      <!-- Baskets Grid -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="fas fa-shopping-basket"></i> High-Value Baskets Analysis</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('baskets')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="row g-3 scrollable-section" id="basketsGrid" style="max-height: 400px; overflow-y: auto;">
        {% for b in basket_stats %}
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
          <div class="basket-card fade-in" data-basket-id="{{ b.basket_id }}">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span style="font-weight: 700; color: #2d3748;">#{{ b.basket_id }}</span>
              <span class="badge bg-success">{{ b.unique_products }} items</span>
            </div>
            <div style="font-size: 1.5rem; font-weight: 800; color: #667eea; margin-bottom: 0.5rem;">
              ${{ b.total_value|floatformat:2 }}
            </div>
            <div style="color: #718096; font-size: 0.9rem;">
              Total Value • Qty {{ b.total_items }}
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="text-center py-4">
            <i class="fas fa-shopping-basket fa-3x text-muted mb-3"></i>
            <h5>No basket data available</h5>
            <p class="text-muted">Load transaction data to see basket analysis.</p>
          </div>
        </div>
        {% endfor %}
        </div>
      </div>
    </div>

    <!-- Predictive Analysis Tab -->
    <div id="predictive" class="tab-content">
      <div class="analysis-type-card predictive-card">
        <h4 style="color: #007bff; margin-bottom: 1rem;">
          <i class="fas fa-crystal-ball"></i>
          Predictive Market Basket Analysis
        </h4>
        <p style="color: #6c757d; line-height: 1.6; margin: 0;">
          Uses machine learning algorithms (Neural Networks, Random Forest, SVM) to predict future purchase 
          patterns based on historical data and customer behavior profiles.
        </p>
      </div>

      <!-- ML Algorithm Selection -->
      <div class="interactive-controls">
        <h5><i class="fas fa-robot"></i> Machine Learning Configuration</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label control-label">Algorithm:</label>
            <select class="form-select" id="mlAlgorithm">
              <option value="neural_network">Neural Network</option>
              <option value="random_forest">Random Forest</option>
              <option value="gradient_boost">Gradient Boosting</option>
              <option value="svm">Support Vector Machine</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label control-label">Prediction Horizon:</label>
            <select class="form-select" id="predictionHorizon">
              <option value="1">1 Month</option>
              <option value="3" selected>3 Months</option>
              <option value="6">6 Months</option>
              <option value="12">12 Months</option>
            </select>
          </div>
          <div class="col-md-4">
            <div class="control-group">
              <label class="control-label">Training Size:</label>
              <input type="range" class="form-range control-slider" id="trainingSizeSlider" min="0.6" max="0.9" step="0.05" value="0.8">
              <span class="control-value" id="trainingSizeValue">80%</span>
            </div>
          </div>
        </div>
        <button class="btn btn-primary mt-2" onclick="runPredictiveAnalysis()">
          <i class="fas fa-play"></i> Train & Predict
        </button>
      </div>

      <!-- Prediction Results -->
      <div class="row g-2">
        <div class="col-md-6">
          <div class="chart-container">
            <h5><i class="fas fa-chart-bar"></i> Revenue Impact by Department</h5>
            <div id="revenueImpactChart" style="min-height: 250px;">
              <div class="text-center py-5 text-muted">
                <i class="fas fa-chart-bar fa-3x mb-3" style="color: #e2e8f0;"></i>
                <h6 style="color: #a0aec0;">Revenue Impact Analysis</h6>
                <p style="color: #cbd5e0; font-size: 0.9rem;">Train your model to see predicted revenue impact by department</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="chart-container">
            <h5><i class="fas fa-calendar-alt"></i> Purchase Probability Trends</h5>
            <div id="purchaseTrendsChart" style="min-height: 250px;">
              <div class="text-center py-5 text-muted">
                <i class="fas fa-chart-line fa-3x mb-3" style="color: #e2e8f0;"></i>
                <h6 style="color: #a0aec0;">Time-Based Predictions</h6>
                <p style="color: #cbd5e0; font-size: 0.9rem;">Forecast purchase probability over 1 month, 3 months, and 1 year periods</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommended Products -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="fas fa-lightbulb"></i> AI-Powered Product Recommendations</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('recommendations')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="recommendations-scroll-container">
          <div class="row g-3" id="recommendedProducts">
            <div class="col-12">
              <div class="text-center py-4 text-muted">
                <i class="fas fa-robot fa-3x mb-3" style="color: #cbd5e0;"></i>
                <h5 style="color: #718096;">AI Recommendations Ready</h5>
                <p style="color: #a0aec0;">Click "Train & Predict" to generate machine learning-powered product recommendations.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Differential Analysis Tab -->
    <div id="differential" class="tab-content">
      <div class="analysis-type-card differential-card">
        <h4 style="color: #dc3545; margin-bottom: 1rem;">
          <i class="fas fa-exchange-alt"></i>
          Differential Market Basket Analysis
        </h4>
        <p style="color: #6c757d; line-height: 1.6; margin: 0;">
          Compares basket patterns between different customer segments, time periods, or store locations 
          using statistical significance tests and cohort analysis.
        </p>
      </div>

      <!-- Comparison Controls -->
      <div class="interactive-controls">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0"><i class="fas fa-filter"></i> Comparison Configuration</h5>
          <button class="btn btn-outline-info btn-sm" onclick="showConfigurationHelp()" title="Configuration Help">
            <i class="fas fa-question-circle"></i> Help
          </button>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">
              Compare By:
              <i class="fas fa-info-circle text-muted ms-1" title="Choose what aspect to compare between different groups"></i>
            </label>
            <select class="form-select" id="compareBy" onchange="updateComparisonDescription()">
              <option value="time">📅 Time Periods (Quarterly Analysis)</option>
              <option value="customer_segment">👥 Customer Segments (High vs Low Value)</option>
              <option value="store">🏪 Store Locations (Urban vs Suburban)</option>
              <option value="season">🌤️ Seasonal Patterns (Weather Impact)</option>
            </select>
            <div class="form-text" id="compareByDescription">
              Compare shopping patterns across different time quarters to identify seasonal trends and temporal changes.
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">
              Statistical Test:
              <i class="fas fa-info-circle text-muted ms-1" title="Statistical method to determine if differences are significant"></i>
            </label>
            <select class="form-select" id="statTest" onchange="updateStatTestDescription()">
              <option value="chi_square">χ² Chi-Square Test (Category Frequencies)</option>
              <option value="t_test">📊 Student's T-Test (Average Comparisons)</option>
              <option value="mann_whitney">📈 Mann-Whitney U (Non-Normal Data)</option>
              <option value="kolmogorov">📉 Kolmogorov-Smirnov (Distributions)</option>
            </select>
            <div class="form-text" id="statTestDescription">
              Tests if category frequencies differ significantly between groups. Best for comparing product category distributions.
            </div>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-8">
            <div class="alert alert-info mb-2" id="analysisPreview">
              <small class="mb-0">
                <strong>📊 Analysis Preview:</strong>
                <span id="previewText">Will compare shopping patterns between different time quarters using Chi-Square test to identify statistically significant differences in product category preferences.</span>
              </small>
            </div>
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" onclick="runDifferentialAnalysis()">
              <i class="fas fa-play"></i> Compare Patterns
            </button>
          </div>
        </div>
      </div>

      <!-- Comparison Results -->
      <div class="row g-2">
        <div class="col-md-8">
          <div class="chart-container">
            <h5><i class="fas fa-chart-bar"></i> Comparative Analysis Results</h5>
            <canvas id="comparisonChart" height="250"></canvas>
          </div>
        </div>
        <div class="col-md-4">
          <div class="metric-grid">
            <div class="metric-item">
              <div class="metric-value" id="pValue">--</div>
              <div class="metric-label">P-Value</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="effectSize">--</div>
              <div class="metric-label">Effect Size</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="significance">--</div>
              <div class="metric-label">Confidence</div>
            </div>
          </div>
          <div class="small text-muted mt-2" id="statNote">Select a statistical test to view methodology.</div>
        </div>
      </div>

      <!-- Differential Insights -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="fas fa-microscope"></i> Key Differential Insights</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('differential')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="row g-3 scrollable-section" id="differentialInsights" style="max-height: 500px; overflow-y: auto;">
          <div class="col-12">
            <div class="text-center py-3 text-muted">
              <i class="fas fa-chart-line fa-2x mb-2"></i>
              <p>Click "Compare Patterns" to generate differential insights...</p>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Department mapping with colors and emojis
const DEPARTMENT_CONFIG = {
  'GROCERY': { color: '#2E86C1', emoji: '🛒', gradient: 'linear-gradient(135deg, #2E86C1, #3498DB)' },
  'MEAT-PCKGD': { color: '#E74C3C', emoji: '🥩', gradient: 'linear-gradient(135deg, #E74C3C, #EC7063)' },
  'PORK': { color: '#C0392B', emoji: '🐷', gradient: 'linear-gradient(135deg, #C0392B, #E74C3C)' },
  'SEAFOOD': { color: '#148F77', emoji: '🐟', gradient: 'linear-gradient(135deg, #148F77, #1ABC9C)' },
  'SEAFOOD-PCKGD': { color: '#0E6655', emoji: '🦐', gradient: 'linear-gradient(135deg, #0E6655, #148F77)' },
  'FROZEN GROCERY': { color: '#85C1E9', emoji: '❄️', gradient: 'linear-gradient(135deg, #85C1E9, #AED6F1)' },
  'DAIRY': { color: '#F39C12', emoji: '🥛', gradient: 'linear-gradient(135deg, #F39C12, #F8C471)' },
  'DELI': { color: '#FF6B6B', emoji: '🥪', gradient: 'linear-gradient(135deg, #FF6B6B, #FF8E8E)' },
  'DELI/SNACK BAR': { color: '#FF5722', emoji: '🌭', gradient: 'linear-gradient(135deg, #FF5722, #FF7043)' },
  'BAKERY': { color: '#D4AC0D', emoji: '🍞', gradient: 'linear-gradient(135deg, #D4AC0D, #F1C40F)' },
  'PASTRY': { color: '#D68910', emoji: '🧁', gradient: 'linear-gradient(135deg, #D68910, #E67E22)' },
  'PRODUCE': { color: '#27AE60', emoji: '🥬', gradient: 'linear-gradient(135deg, #27AE60, #2ECC71)' },
  'FLORAL': { color: '#FF69B4', emoji: '🌸', gradient: 'linear-gradient(135deg, #FF69B4, #FF1493)' },
  'PHARMACY SUPPLY': { color: '#8E44AD', emoji: '💊', gradient: 'linear-gradient(135deg, #8E44AD, #9B59B6)' },
  'RX': { color: '#7D3C98', emoji: '💉', gradient: 'linear-gradient(135deg, #7D3C98, #8E44AD)' },
  'DRUG GM': { color: '#A569BD', emoji: '🩹', gradient: 'linear-gradient(135deg, #A569BD, #BB8FCE)' },
  'SPIRITS': { color: '#795548', emoji: '🍷', gradient: 'linear-gradient(135deg, #795548, #8D6E63)' },
  'BEVERAGE': { color: '#17A2B8', emoji: '🥤', gradient: 'linear-gradient(135deg, #17A2B8, #20C997)' },
  'TOYS': { color: '#FF1493', emoji: '🧸', gradient: 'linear-gradient(135deg, #FF1493, #FF69B4)' },
  'VIDEO': { color: '#9C27B0', emoji: '📺', gradient: 'linear-gradient(135deg, #9C27B0, #BA68C8)' },
  'PHOTO': { color: '#607D8B', emoji: '📷', gradient: 'linear-gradient(135deg, #607D8B, #78909C)' },
  'ELECT &PLUMBING': { color: '#FF9800', emoji: '🔧', gradient: 'linear-gradient(135deg, #FF9800, #FFB74D)' },
  'MISC. TRANS.': { color: '#6C757D', emoji: '📦', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' },
  'MISC SALES TRAN': { color: '#6C757D', emoji: '🛍️', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' },
  'COUP/STR & MFG': { color: '#28A745', emoji: '🎫', gradient: 'linear-gradient(135deg, #28A745, #34CE57)' },
  'DEFAULT': { color: '#6C757D', emoji: '📦', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' }
};

// Global variables for analysis
let currentAnalysisData = {};
let charts = {};

// Tab switching functionality
function switchTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });

  // Remove active class from all buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  // Show selected tab content
  const targetTab = document.getElementById(tabName);
  if (targetTab) {
    targetTab.classList.add('active');
  }

  // Add active class to the correct button based on tab name
  const buttons = document.querySelectorAll('.tab-btn');
  buttons.forEach(btn => {
    const onclick = btn.getAttribute('onclick');
    if (onclick && onclick.includes(`'${tabName}'`)) {
      btn.classList.add('active');
    }
  });

  // Initialize tab-specific content
  initializeTab(tabName);
}

function initializeTab(tabName) {
  switch(tabName) {
    case 'descriptive':
      loadDescriptiveAnalysis();
      break;
    case 'predictive':
      loadPredictiveAnalysis();
      break;
    case 'differential':
      loadDifferentialAnalysis();
      break;
  }
}

// Create department badge
function createDepartmentBadge(department) {
  const config = DEPARTMENT_CONFIG[department] || DEPARTMENT_CONFIG['DEFAULT'];
  return `
    <span class="department-badge" style="background: ${config.gradient};">
      ${config.emoji} ${department}
    </span>
  `;
}

// Commodity mapping with colors and emojis (based on actual DB commodities)
const COMMODITY_CONFIG = {
  // Frozen Items
  'FRZN ICE': { color: '#3B82F6', emoji: '🧊', gradient: 'linear-gradient(135deg, #3B82F6, #60A5FA)' },
  'ICE CREAM/MILK/SHERBTS': { color: '#EC4899', emoji: '🍦', gradient: 'linear-gradient(135deg, #EC4899, #F472B6)' },
  
  // Bakery & Bread
  'BREAD': { color: '#D4AC0D', emoji: '🍞', gradient: 'linear-gradient(135deg, #D4AC0D, #F1C40F)' },
  'COOKIES/CONES': { color: '#8B4513', emoji: '🍪', gradient: 'linear-gradient(135deg, #8B4513, #A0522D)' },
  'BREAKFAST SWEETS': { color: '#FF6B6B', emoji: '🧁', gradient: 'linear-gradient(135deg, #FF6B6B, #FF8E8E)' },
  
  // Pantry & Condiments  
  'PNT BTR/JELLY/JAMS': { color: '#9C27B0', emoji: '🫙', gradient: 'linear-gradient(135deg, #9C27B0, #BA68C8)' },
  'SPICES & EXTRACTS': { color: '#FF5722', emoji: '🌶️', gradient: 'linear-gradient(135deg, #FF5722, #FF7043)' },
  
  // Health & Wellness
  'VITAMINS': { color: '#4CAF50', emoji: '💊', gradient: 'linear-gradient(135deg, #4CAF50, #66BB6A)' },
  
  // Fresh Produce
  'FRUIT - SHELF STABLE': { color: '#FF9800', emoji: '🍎', gradient: 'linear-gradient(135deg, #FF9800, #FFB74D)' },
  
  // Beverages
  'SOFT DRINKS': { color: '#2196F3', emoji: '🥤', gradient: 'linear-gradient(135deg, #2196F3, #42A5F5)' },
  'COFFEE': { color: '#5D4037', emoji: '☕', gradient: 'linear-gradient(135deg, #5D4037, #6D4C41)' },
  'MILK': { color: '#FFF8E1', emoji: '🥛', gradient: 'linear-gradient(135deg, #FFF8E1, #FFFDE7)', textColor: '#333' },
  
  // Snacks
  'CHIPS': { color: '#FFC107', emoji: '🥔', gradient: 'linear-gradient(135deg, #FFC107, #FFD54F)' },
  'COOKIES': { color: '#795548', emoji: '🍪', gradient: 'linear-gradient(135deg, #795548, #8D6E63)' },
  
  // Dairy
  'BUTTER': { color: '#FFEB3B', emoji: '🧈', gradient: 'linear-gradient(135deg, #FFEB3B, #FFF176)', textColor: '#333' },
  'YOGURT': { color: '#E91E63', emoji: '🥛', gradient: 'linear-gradient(135deg, #E91E63, #F06292)' },
  
  // Pantry Staples
  'PASTA': { color: '#FF7043', emoji: '🍝', gradient: 'linear-gradient(135deg, #FF7043, #FF8A65)' },
  'TOMATO SAUCE': { color: '#F44336', emoji: '🍅', gradient: 'linear-gradient(135deg, #F44336, #EF5350)' },
  'CEREAL': { color: '#9E9E9E', emoji: '🥣', gradient: 'linear-gradient(135deg, #9E9E9E, #BDBDBD)' },
  
  // Frozen Foods
  'PIZZA': { color: '#FF5722', emoji: '🍕', gradient: 'linear-gradient(135deg, #FF5722, #FF7043)' },
  
  // Sweets & Desserts
  'CHOCOLATE': { color: '#3E2723', emoji: '🍫', gradient: 'linear-gradient(135deg, #3E2723, #5D4037)' },
  'GRANOLA BARS': { color: '#8BC34A', emoji: '🥜', gradient: 'linear-gradient(135deg, #8BC34A, #9CCC65)' },
  
  // Dairy Products
  'CREAMER': { color: '#FFF3E0', emoji: '🥛', gradient: 'linear-gradient(135deg, #FFF3E0, #FFE0B2)', textColor: '#333' },
  
  // Cleaning
  'DETERGENT': { color: '#00BCD4', emoji: '🧼', gradient: 'linear-gradient(135deg, #00BCD4, #26C6DA)' },
  'FABRIC SOFTENER': { color: '#E1BEE7', emoji: '🧺', gradient: 'linear-gradient(135deg, #E1BEE7, #F3E5F5)', textColor: '#333' },
  
  // Default for unknown commodities
  'NO COMMODITY DESCRIPTION': { color: '#6C757D', emoji: '📦', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' },
  'DEFAULT': { color: '#6C757D', emoji: '🛒', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' }
};

// Create commodity badge with proper colors and emojis
function createCommodityBadge(name) {
  const config = COMMODITY_CONFIG[name] || COMMODITY_CONFIG['DEFAULT'];
  const textColor = config.textColor || '#ffffff';
  return `
    <span class="commodity-badge" style="
      background: ${config.gradient};
      color: ${textColor};
      font-weight: 600;
      border-radius: 15px;
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    ">
      ${config.emoji} ${name.length > 12 ? name.substring(0, 10) + '...' : name}
    </span>
  `;
}

function escapeHtml(value) {
  if (value === undefined || value === null) {
    return '';
  }
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function renderDifferentialInsightCard(insight, compareBy, statTest) {
  const impactLevel = (insight.impact || 'Medium').trim();
  const departmentIcon = insight.department ? createDepartmentBadge(insight.department) : '';
  const commodityIcon = insight.commodity ? createCommodityBadge(insight.commodity) : '';
  const statLabel = statTest.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
  const compareLabel = compareBy.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
  const topProducts = Array.isArray(insight.top_products)
    ? insight.top_products
    : (Array.isArray(insight.topProducts) ? insight.topProducts : []);
  const productBadges = topProducts.slice(0, 3).map(product => {
    const name = escapeHtml(product.name || product.commodity || `Product ${product.product_id || ''}`);
    const share = product.share !== undefined && product.share !== null
      ? `<span style="color: #64748b;"> (${Number(product.share).toFixed(1)}%)</span>`
      : '';
    return `<span class="product-chip" style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 999px; padding: 4px 10px; font-size: 0.75rem; color: #334155; display: inline-flex; align-items: center; gap: 4px;">${name}${share}</span>`;
  }).join('');
  const productSection = productBadges ? `
    <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 8px; margin-bottom: 0.75rem;">
      <div style="font-size: 0.75rem; font-weight: 600; color: #475569; margin-bottom: 6px;"><i class="fas fa-box-open me-1"></i>Top Products Driving This Insight</div>
      <div style="display: flex; flex-wrap: wrap; gap: 6px;">${productBadges}</div>
    </div>
  ` : '';
  const encodedProducts = encodeURIComponent(JSON.stringify(topProducts || []));
  return `
    <div class="col-12 col-md-6">
      <div class="differential-insight-card fade-in"
           style="cursor: pointer; transition: all 0.3s ease; border-left: 4px solid ${impactLevel === 'High' ? '#dc3545' : '#ffc107'} !important;"
           data-insight-title="${escapeHtml(insight.title || '')}"
           data-insight-description="${escapeHtml(insight.description || '')}"
           data-insight-impact="${escapeHtml(impactLevel)}"
           data-insight-recommendation="${escapeHtml(insight.recommendation || '')}"
           data-compare-by="${escapeHtml(compareBy)}"
           data-stat-test="${escapeHtml(statTest)}"
           data-products="${encodedProducts}"
           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'"
           onclick="showDifferentialInsightDetailsFromCard(this)">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex align-items-center gap-2">
            ${departmentIcon}
            <span style="font-weight: 700; color: #2d3748; font-size: 0.95rem;">${escapeHtml(insight.title || '')}</span>
          </div>
          <span class="badge ${impactLevel === 'High' ? 'bg-danger' : 'bg-warning'}">${escapeHtml(impactLevel)} Impact</span>
        </div>
        <div class="d-flex align-items-center gap-2 mb-2">
          ${commodityIcon}
        </div>
        <div style="font-size: 0.9rem; color: #718096; margin-bottom: 0.75rem; line-height: 1.4;">
          ${escapeHtml(insight.description || '')}
        </div>
        ${productSection}
        <div style="background: #f7fafc; padding: 8px 12px; border-radius: 6px; margin-bottom: 0.75rem;">
          <div style="font-size: 0.8rem; font-weight: 600; color: #4a5568;">💡 ${escapeHtml(insight.recommendation || 'Review action plan')}</div>
        </div>
        <div style="color: #a0aec0; font-size: 0.75rem; display: flex; align-items: center; gap: 8px;">
          <span><i class="fas fa-chart-bar"></i> ${escapeHtml(statLabel)}</span>
          <span>•</span>
          <span><i class="fas fa-filter"></i> ${escapeHtml(compareLabel)}</span>
        </div>
      </div>
    </div>
  `;
}


// Descriptive Analysis Functions
function loadDescriptiveAnalysis() {
  generateAssociationRules();
  updateSliderValues();
}

function generateAssociationRules() {
  const supportThreshold = parseFloat(document.getElementById('supportSlider')?.value || 0.05);
  const confidenceThreshold = parseFloat(document.getElementById('confidenceSlider')?.value || 0.6);
  
  // Department-level demo rules
  const allRules = [
    { antecedent: 'PORK', consequent: 'GROCERY', support: 0.15, confidence: 0.85, lift: 2.3 },
    { antecedent: 'SEAFOOD', consequent: 'FROZEN GROCERY', support: 0.12, confidence: 0.78, lift: 2.1 },
    { antecedent: 'DELI', consequent: 'BAKERY', support: 0.18, confidence: 0.72, lift: 1.9 },
    { antecedent: 'DAIRY', consequent: 'GROCERY', support: 0.22, confidence: 0.88, lift: 2.5 },
    { antecedent: 'SPIRITS', consequent: 'SEAFOOD', support: 0.08, confidence: 0.65, lift: 1.8 },
    { antecedent: 'PHARMACY SUPPLY', consequent: 'DRUG GM', support: 0.14, confidence: 0.76, lift: 2.2 },
    { antecedent: 'FLORAL', consequent: 'TOYS', support: 0.06, confidence: 0.58, lift: 1.7 },
    { antecedent: 'PRODUCE', consequent: 'GROCERY', support: 0.25, confidence: 0.82, lift: 2.1 },
    { antecedent: 'BEVERAGE', consequent: 'DAIRY', support: 0.16, confidence: 0.74, lift: 1.8 },
    { antecedent: 'MEAT-PCKGD', consequent: 'FROZEN GROCERY', support: 0.11, confidence: 0.69, lift: 1.6 }
  ];
  
  // Filter department rules based on thresholds (simulating Apriori algorithm) - SHOW ALL
  const rules = allRules.filter(rule => 
    rule.support >= supportThreshold && rule.confidence >= confidenceThreshold
  ).sort((a, b) => b.lift - a.lift); // Remove .slice(0, 10) to show ALL results
  
  // Department rules HTML (showing count) with click functionality
  const deptRulesHtml = rules.length > 0 ? rules.map(rule => `
    <div class="rule-card" onclick="showRuleDetails('${rule.antecedent}', '${rule.consequent}', ${rule.support}, ${rule.confidence}, ${rule.lift}, 'department')">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center flex-wrap">
          ${createDepartmentBadge(rule.antecedent)}
          <span class="rule-arrow">→</span>
          ${createDepartmentBadge(rule.consequent)}
        </div>
        <div class="text-muted small">
          Lift: <strong style="color: #28a745;">${rule.lift}</strong>
        </div>
      </div>
      <div class="row g-2 text-center">
        <div class="col-4">
          <div class="small text-muted">Support</div>
          <div class="fw-bold">${(rule.support * 100).toFixed(1)}%</div>
        </div>
        <div class="col-4">
          <div class="small text-muted">Confidence</div>
          <div class="fw-bold">${(rule.confidence * 100).toFixed(1)}%</div>
        </div>
        <div class="col-4">
          <div class="small text-muted">Lift</div>
          <div class="fw-bold">${rule.lift}</div>
        </div>
      </div>
      <div class="confidence-bar">
        <div class="confidence-fill" style="width: ${rule.confidence * 100}%"></div>
      </div>
    </div>
  `).join('') : '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle fa-2x mb-2"></i><p>No department rules found with current thresholds.<br>Try lowering the support or confidence values.</p></div>';
  
  // Update department rules container
  const containerDept = document.getElementById('associationRules');
  if(containerDept) {
    containerDept.innerHTML = deptRulesHtml;
    // Update section title with count (infinity symbol for unlimited)
    const deptTitle = document.getElementById('deptRulesTitle');
    if(deptTitle) deptTitle.innerHTML = `<i class="fas fa-project-diagram"></i> Association Rules (${rules.length}/∞) — Department Level`;
  }

  // Commodity-level demo rules (based on commodity_desc)
  const commodityRulesAll = [
    { ant: 'BREAD', con: 'PNT BTR/JELLY/JAMS', support: 0.12, confidence: 0.76, lift: 2.1 },
    { ant: 'BREAKFAST SWEETS', con: 'COFFEE', support: 0.14, confidence: 0.82, lift: 2.3 },
    { ant: 'ICE CREAM/MILK/SHERBTS', con: 'COOKIES/CONES', support: 0.13, confidence: 0.78, lift: 2.2 },
    { ant: 'PNT BTR/JELLY/JAMS', con: 'BREAD', support: 0.12, confidence: 0.74, lift: 2.0 },
    { ant: 'COFFEE', con: 'BREAKFAST SWEETS', support: 0.10, confidence: 0.71, lift: 1.9 },
    { ant: 'COOKIES/CONES', con: 'ICE CREAM/MILK/SHERBTS', support: 0.09, confidence: 0.69, lift: 1.8 },
    { ant: 'BREAD', con: 'FRUIT - SHELF STABLE', support: 0.09, confidence: 0.65, lift: 1.8 },
    { ant: 'SPICES & EXTRACTS', con: 'FRUIT - SHELF STABLE', support: 0.08, confidence: 0.66, lift: 1.7 },
    { ant: 'VITAMINS', con: 'FRZN ICE', support: 0.07, confidence: 0.62, lift: 1.6 },
    { ant: 'FRZN ICE', con: 'VITAMINS', support: 0.06, confidence: 0.58, lift: 1.5 },
    { ant: 'SPICES & EXTRACTS', con: 'VITAMINS', support: 0.05, confidence: 0.55, lift: 1.4 }
  ];
  // Filter commodity rules using SAME thresholds as department rules - SHOW ALL
  const commodityRules = commodityRulesAll.filter(r => 
    r.support >= supportThreshold && r.confidence >= confidenceThreshold
  ).sort((a,b)=>b.lift-a.lift); // Remove .slice(0,10) to show ALL results
  // Commodity rules HTML (showing count) with click functionality
  const commodityHtml = commodityRules.length > 0 ? commodityRules.map(r=>`
    <div class="rule-card" onclick="showRuleDetails('${r.ant}', '${r.con}', ${r.support}, ${r.confidence}, ${r.lift}, 'commodity')">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center flex-wrap">
          ${createCommodityBadge(r.ant)}
          <span class="rule-arrow">→</span>
          ${createCommodityBadge(r.con)}
        </div>
        <div class="text-muted small">Lift: <strong style="color:#28a745;">${r.lift}</strong></div>
      </div>
      <div class="row g-2 text-center">
        <div class="col-4"><div class="small text-muted">Support</div><div class="fw-bold">${(r.support*100).toFixed(1)}%</div></div>
        <div class="col-4"><div class="small text-muted">Confidence</div><div class="fw-bold">${(r.confidence*100).toFixed(1)}%</div></div>
        <div class="col-4"><div class="small text-muted">Lift</div><div class="fw-bold">${r.lift}</div></div>
      </div>
      <div class="confidence-bar"><div class="confidence-fill" style="width:${r.confidence*100}%"></div></div>
    </div>
  `).join('') : '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle fa-2x mb-2"></i><p>No commodity rules found with current thresholds.<br>Try lowering the support or confidence values.</p></div>';
  
  // Update commodity rules container
  const containerCom = document.getElementById('associationRulesCommodity');
  if(containerCom) {
    containerCom.innerHTML = commodityHtml;
    // Update section title with count (infinity symbol for unlimited)
    const comTitle = document.getElementById('commodityRulesTitle');
    if(comTitle) comTitle.innerHTML = `<i class="fas fa-boxes-stacked"></i> Association Rules (${commodityRules.length}/∞) — Commodity Level`;
  }
}

function updateSliderValues() {
  const supportSlider = document.getElementById('supportSlider');
  const confidenceSlider = document.getElementById('confidenceSlider');
  const supportValue = document.getElementById('supportValue');
  const confidenceValue = document.getElementById('confidenceValue');
  
  if (supportSlider && supportValue) {
    supportSlider.addEventListener('input', (e) => {
      supportValue.textContent = parseFloat(e.target.value).toFixed(2);
    });
  }
  
  if (confidenceSlider && confidenceValue) {
    confidenceSlider.addEventListener('input', (e) => {
      confidenceValue.textContent = parseFloat(e.target.value).toFixed(2);
    });
  }
}

function runDescriptiveAnalysis() {
  const supportValue = document.getElementById('supportSlider')?.value || 0.05;
  const confidenceValue = document.getElementById('confidenceSlider')?.value || 0.6;
  
  showNotification(`Running Apriori algorithm (min_support=${supportValue}, min_confidence=${confidenceValue})...`, 'info');
  
  // Show loading state for both containers
  const loadingHtml = `
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Mining frequent itemsets...</p>
      <small class="text-muted">Scanning transaction database...</small>
    </div>
  `;
  
  document.getElementById('associationRules').innerHTML = loadingHtml;
  document.getElementById('associationRulesCommodity').innerHTML = loadingHtml;
  
  // Simulate realistic algorithm execution time
  setTimeout(() => {
    generateAssociationRules();
    updateMetrics();
    
    const deptRules = document.getElementById('associationRules').querySelectorAll('.rule-card').length;
    const commodityRules = document.getElementById('associationRulesCommodity').querySelectorAll('.rule-card').length;
    const total = deptRules + commodityRules;
    
    showNotification(`Apriori completed! Found ${total} strong association rules (${deptRules} department + ${commodityRules} commodity).`, 'success');
  }, Math.random() * 2000 + 1500);
}

function updateMetrics() {
  // Count actual rules generated (excluding loading/empty state divs)
  const deptContainer = document.getElementById('associationRules');
  const commodityContainer = document.getElementById('associationRulesCommodity');
  
  const deptRules = deptContainer ? deptContainer.querySelectorAll('.rule-card').length : 0;
  const commodityRules = commodityContainer ? commodityContainer.querySelectorAll('.rule-card').length : 0;
  const totalRules = deptRules + commodityRules;
  
  const elements = {
    strongRules: document.getElementById('strongRules'),
    topLift: document.getElementById('topLift')
  };
  
  if (elements.strongRules) {
    elements.strongRules.textContent = totalRules;
    // Update the label description
    const label = elements.strongRules.nextElementSibling;
    if (label && totalRules > 0) {
      label.innerHTML = `Strong Rules Found<br><small style="color: #6c757d; font-size: 0.6rem;">${deptRules} dept + ${commodityRules} commodity</small>`;
    }
  }
  
  if (elements.topLift && totalRules > 0) {
    elements.topLift.textContent = '2.5';
  }
}

// Predictive Analysis Functions
function loadPredictiveAnalysis() {
  initializePredictiveCharts();
  generateRecommendations();
  updateTrainingSlider();

  // Test API call immediately to verify real data access
  console.log('Testing API access on page load...');
  testApiAccess();
}

// Test API access to verify we can get real data
function testApiAccess() {
  fetch('/analysis/api/ml/predictions/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=neural_network&time_horizon=${getSelectedHorizon()}`
  })
  .then(response => response.json())
  .then(data => {
    console.log('API test result:', data);
    if (data.success && data.predictions && data.predictions.length > 0) {
      console.log('✓ API working - real data available');
      console.log('Sample prediction:', data.predictions[0]);
    } else {
      console.error('✗ API test failed - no real data available');
      console.error('Error details:', data);
    }
  })
  .catch(error => {
    console.error('✗ API test failed with error:', error);
  });
}

function updateTrainingSlider() {
  const slider = document.getElementById('trainingSizeSlider');
  const value = document.getElementById('trainingSizeValue');
  
  if (slider && value) {
    slider.addEventListener('input', (e) => {
      value.textContent = `${Math.round(parseFloat(e.target.value) * 100)}%`;
    });
  }
}

function initializePredictiveCharts() {
  // Initialize empty chart containers - charts will be populated after training
  console.log('Predictive charts initialized - waiting for model training');
}

function generateRecommendations() {
  const algorithm = document.getElementById('mlAlgorithm').value;
  const timeHorizon = getSelectedHorizon();
  const horizonLabel = getHorizonLabel(timeHorizon);
  const container = document.getElementById('recommendedProducts');

  if (container) {
    container.innerHTML = '<div class="col-12 text-center"><i class="fas fa-spinner fa-spin fa-2x mb-2" style="color: #667eea;"></i><h6 style="color: #4a5568;">Generating ' + horizonLabel + ' Recommendations...</h6><p style="color: #a0aec0;">Using ' + algorithm.replace('_', ' ').toUpperCase() + ' algorithm for ' + horizonLabel.toLowerCase() + ' predictions</p></div>';
  }

  // Call ML API for recommendations with time horizon
  fetch('/analysis/api/ml/recommendations/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=${algorithm}&top_n=8&time_horizon=${timeHorizon}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.recommendations.length > 0) {
      const html = data.recommendations.map(rec => {
        const departmentColor = DEPARTMENT_CONFIG[rec.department]?.color || '#6C757D';
        const brand = escapeHtml(rec.brand || 'Unknown Brand');
        const commodityName = escapeHtml(rec.commodity || 'All Products');
        const subCommodity = rec.sub_commodity ? escapeHtml(rec.sub_commodity) : '';
        const manufacturer = escapeHtml(rec.manufacturer || 'Unknown Manufacturer');
        const size = escapeHtml(rec.size || 'N/A');
        const households = Number(rec.customer_count || 0).toLocaleString();
        const formattedRevenueImpact = Number(rec.revenue_impact || 0).toLocaleString();
        const formattedAvgValue = Number(rec.avg_value || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formattedTotalValue = Number(rec.total_value || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formattedTotalQuantity = Number(rec.total_quantity || 0).toLocaleString();
        const commodityBadge = createCommodityBadge(rec.commodity || 'All Products');
        const subtitle = subCommodity ? `${commodityName} • ${subCommodity}` : commodityName;

        return `
          <div class="col-12 col-md-6 col-xl-4">
            <div class="recommendation-card h-100"
                 style="border-left: 6px solid ${departmentColor}; cursor: pointer; transition: all 0.3s ease;"
                 data-product-id="${escapeHtml(rec.product_id)}"
                 data-department="${escapeHtml(rec.department || '')}"
                 data-commodity="${escapeHtml(rec.commodity || '')}"
                 data-sub-commodity="${escapeHtml(rec.sub_commodity || '')}"
                 data-brand="${escapeHtml(rec.brand || '')}"
                 data-size="${escapeHtml(rec.size || '')}"
                 data-manufacturer="${escapeHtml(rec.manufacturer || '')}"
                 data-confidence="${rec.confidence}"
                 data-revenue-impact="${rec.revenue_impact}"
                 data-customer-count="${rec.customer_count || 0}"
                 data-avg-value="${rec.avg_value || 0}"
                 data-total-value="${rec.total_value || 0}"
                 data-total-quantity="${rec.total_quantity || 0}"
                 onmouseover="this.style.borderLeft='6px solid ' + '${departmentColor}'; this.style.boxShadow='0 20px 40px rgba(99, 102, 241, 0.25)'"
                 onmouseout="this.style.borderLeft='6px solid ' + '${departmentColor}'; this.style.boxShadow=''">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3 gap-2">
                  ${createDepartmentBadge(rec.department || 'MISC. TRANS.')}
                  <span class="product-id-badge" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">ID ${escapeHtml(rec.product_id)}</span>
                  <span class="ms-auto badge" style="background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; padding: 6px 12px; border-radius: 15px; font-weight: 700; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);">${(Number(rec.confidence) * 100).toFixed(0)}%</span>
                </div>

                <div class="mb-3">
                  <h6 class="card-title mb-1" style="color: #1a202c; font-weight: 700; font-size: 1.1rem; line-height: 1.3;">${brand}</h6>
                  <small class="text-muted d-block" style="font-size: 0.85rem; color: #64748b;">${subtitle}</small>
                </div>

                <div class="revenue-highlight mb-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(67, 56, 202, 0.05)); padding: 1rem; border-radius: 12px; border-left: 4px solid #667eea;">
                  <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-chart-line" style="color: #667eea; font-size: 1.2rem;"></i>
                    <span class="fw-bold text-primary" style="font-size: 1.4rem; color: #667eea !important;">+$${formattedRevenueImpact}</span>
                  </div>
                  <div class="text-muted small mt-1" style="font-weight: 500;">Predicted Revenue Impact</div>
                </div>

                <div class="product-details mb-3" style="background: rgba(248, 250, 252, 0.8); padding: 0.75rem; border-radius: 10px;">
                  <div class="d-flex align-items-center gap-2 mb-2" style="color: #4a5568;">
                    <i class="fas fa-industry" style="color: #667eea; width: 16px;"></i>
                    <span style="font-size: 0.9rem;"><strong>Manufacturer:</strong> ${manufacturer}</span>
                  </div>
                  <div class="recommendation-meta">
                    <div class="meta-item"><i class="fas fa-box-open" style="color: #667eea;"></i><span><strong>Size:</strong> ${size}</span></div>
                    <div class="meta-item"><i class="fas fa-users" style="color: #667eea;"></i><span><strong>Households:</strong> ${households}</span></div>
                    <div class="meta-item"><i class="fas fa-shopping-basket" style="color: #667eea;"></i><span><strong>Units:</strong> ${formattedTotalQuantity}</span></div>
                    <div class="meta-item"><i class="fas fa-coins" style="color: #667eea;"></i><span><strong>Total Sales:</strong> $${formattedTotalValue}</span></div>
                    <div class="meta-item"><i class="fas fa-receipt" style="color: #667eea;"></i><span><strong>Avg Basket:</strong> $${formattedAvgValue}</span></div>
                  </div>
                </div>

                <div class="mt-auto">
                  <div class="mb-2">${commodityBadge}</div>
                  <div class="click-indicator" style="text-align: center; padding: 0.5rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(67, 56, 202, 0.02)); border-radius: 8px; border: 1px dashed rgba(102, 126, 234, 0.3);">
                    <i class="fas fa-mouse-pointer" style="color: #667eea;"></i>
                    <span style="color: #667eea; font-weight: 600; font-size: 0.85rem; margin-left: 0.5rem;">Click for detailed analytics</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      if (container) {
        container.innerHTML = html;
        initializeRecommendationCards(container);
      }
    } else {
      if (container) {
        container.innerHTML = `
      <div class="col-12">
        <div class="text-center py-4 text-muted">
          <i class="fas fa-robot fa-3x mb-3" style="color: #cbd5e0;"></i>
          <h5 style="color: #718096;">No Recommendations Yet</h5>
          <p style="color: #a0aec0;">Click "Train & Predict" to generate AI-powered product recommendations using ${algorithm.replace('_', ' ').toUpperCase()} algorithm.</p>
        </div>
      </div>
    `;
      }
    }
  })
  .catch(error => {
    console.error('Error loading recommendations:', error);
    if (container) {
      container.innerHTML = '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-circle fa-2x mb-2"></i><p>Error loading recommendations</p></div>';
    }
  });
}

function initializeRecommendationCards(scope = document) {
  if (!scope || !scope.querySelectorAll) {
    console.warn('Invalid scope provided to initializeRecommendationCards');
    return;
  }

  const cards = scope.querySelectorAll('.recommendation-card');
  console.log(`Initializing ${cards.length} recommendation cards`);

  cards.forEach((card, index) => {
    // Skip if already attached unless explicitly re-initializing
    if (card.dataset.listenerAttached === 'true' && scope === document) {
      return;
    }

    // Ensure card is clickable
    card.style.cursor = 'pointer';

    // Add click handler
    const clickHandler = () => {
      console.log(`Clicked recommendation card ${index + 1}`);
      showRecommendationDetails(
        card.dataset.productId,
        card.dataset.department,
        card.dataset.commodity,
        card.dataset.confidence,
        card.dataset.revenueImpact,
        card.dataset.manufacturer,
        card.dataset.brand,
        card.dataset.subCommodity,
        card.dataset.size,
        card.dataset.customerCount,
        card.dataset.avgValue,
        card.dataset.totalValue,
        card.dataset.totalQuantity
      );
    };

    // Add event listener
    card.addEventListener('click', clickHandler);

    // Mark as attached
    card.dataset.listenerAttached = 'true';
    console.log(`Attached click listener to recommendation card ${index + 1}`);
  });
}

function runPredictiveAnalysis() {
  const algorithm = document.getElementById('mlAlgorithm').value;
  const trainingSize = document.getElementById('trainingSizeSlider').value;
  const timeHorizon = getSelectedHorizon();
  const horizonLabel = getHorizonLabel(timeHorizon);

  showNotification(`Training ${algorithm.replace('_', ' ')} model for ${horizonLabel.toLowerCase()} predictions...`, 'info');
  
  // First, train the ML models
  fetch('/analysis/api/ml/train/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=${algorithm}&training_size=${trainingSize}&time_horizon=${timeHorizon}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Model training started successfully!', 'success');
      
      // Poll training status
      checkTrainingStatus(algorithm);
      
      // Load predictions and recommendations immediately
      loadPredictiveResults(algorithm);
      generateRecommendations();

      // Also load after a delay to catch any training updates
      setTimeout(() => {
        loadPredictiveResults(algorithm);
        generateRecommendations();
      }, 3000);
      
    } else {
      showNotification(`Training failed: ${data.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Error training model:', error);
    showNotification('Error starting model training', 'error');
  });
}

function checkTrainingStatus(algorithm) {
  const statusInterval = setInterval(() => {
    fetch('/analysis/api/ml/training-status/', {
      method: 'GET',
      headers: {
        'X-CSRFToken': getCsrfToken()
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'completed') {
        clearInterval(statusInterval);
        showNotification('Model training completed successfully!', 'success');
        loadModelPerformance(algorithm);

        // Reload charts with updated model predictions
        setTimeout(() => {
          console.log('Training completed, reloading charts');
          loadPredictiveResults(algorithm);
        }, 1000);
      } else if (data.status === 'failed') {
        clearInterval(statusInterval);
        showNotification('Model training failed', 'error');
      }
    })
    .catch(error => {
      console.error('Error checking training status:', error);
      clearInterval(statusInterval);
    });
  }, 3000);
}

function loadPredictiveResults(algorithm) {
  const timeHorizon = getSelectedHorizon();
  const horizonLabel = getHorizonLabel(timeHorizon);
  console.log(`Loading predictive results for algorithm: ${algorithm}, horizon: ${horizonLabel}`);

  // Load department predictions for charts
  fetch('/analysis/api/ml/predictive/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=${algorithm}&time_horizon=${timeHorizon}`
  })
  .then(response => {
    console.log('Department API response status:', response.status);
    return response.json();
  })
  .then(departmentData => {
    console.log('Department predictions API response:', departmentData);

    // Handle department predictions for charts
    if (departmentData.success && departmentData.department_predictions && departmentData.department_predictions.length > 0) {
      console.log(`Found ${departmentData.department_predictions.length} department predictions`);
      console.log('First department sample:', departmentData.department_predictions[0]);
      console.log('Calling updatePredictiveCharts with department data...');
      updatePredictiveCharts(departmentData.department_predictions, algorithm);
    } else {
      console.error('No department predictions found!');
      console.error('Department API Response details:', {
        success: departmentData.success,
        department_predictions: departmentData.department_predictions,
        error: departmentData.error
      });
      showChartError('No department predictions found. Please ensure the model is trained.');
    }
  })
  .catch(error => {
    console.error('Error loading department predictions:', error);
    showChartError('Error loading department predictions. Please try again.');
  });

  // Also load product recommendations for insights
  fetch('/analysis/api/ml/predictions/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=${algorithm}&time_horizon=${timeHorizon}`
  })
  .then(response => response.json())
  .then(productData => {
    console.log('Product predictions API response:', productData);

    // Handle product recommendations for insights
    if (productData.success && productData.predictions && productData.predictions.length > 0) {
      console.log(`Found ${productData.predictions.length} product recommendations`);
      generateTimeBasedInsights(productData.predictions, algorithm);
    } else {
      console.error('No product predictions found!');
    }
  })
  .catch(error => {
    console.error('Error loading product predictions:', error);
  });
}

// Show error in chart containers when no real data is available
function showChartError(message) {
  const revenueContainer = document.getElementById('revenueImpactChart');
  const trendsContainer = document.getElementById('purchaseTrendsChart');

  const errorHtml = `
    <div class="text-center py-5 text-danger">
      <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
      <h6>Real Data Required</h6>
      <p style="font-size: 0.9rem;">${message}</p>
    </div>
  `;

  if (revenueContainer) revenueContainer.innerHTML = errorHtml;
  if (trendsContainer) trendsContainer.innerHTML = errorHtml;
}

function loadModelPerformance(algorithm) {
  fetch('/analysis/api/ml/performance/', {
    method: 'GET',
    headers: {
      'X-CSRFToken': getCsrfToken()
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.performance) {
      updateAccuracyChart(data.performance);
    }
  })
  .catch(error => {
    console.error('Error loading model performance:', error);
  });
}

// Differential Analysis Functions
function loadDifferentialAnalysis() {
  // Don't show initial results - wait for user to click "Compare Patterns"
  // Chart and insights will be populated after running analysis
}


function initializeComparisonChart() {
  const ctx = document.getElementById('comparisonChart');
  if (!ctx) {
    return;
  }

  if (charts.comparison) {
    charts.comparison.destroy();
  }

  const compareBy = document.getElementById('compareBy')?.value || 'time';

  const fallbackMap = {
    'time': {
      labels: ['Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024'],
      datasets: [
        {
          label: 'Sales Volume',
          data: [2450, 2780, 3120, 3650],
          backgroundColor: 'rgba(102, 126, 234, 0.8)',
          borderColor: 'rgba(102, 126, 234, 1)',
          borderWidth: 2,
          type: 'bar'
        },
        {
          label: 'Basket Size',
          data: [1850, 2100, 2250, 2890],
          backgroundColor: 'rgba(118, 75, 162, 0.8)',
          borderColor: 'rgba(118, 75, 162, 1)',
          borderWidth: 2,
          type: 'bar'
        }
      ],
      yAxisLabel: 'Sales ($K)'
    },
    'customer_segment': {
      labels: ['GROCERY', 'MEAT-PCKGD', 'DAIRY', 'FROZEN', 'PRODUCE'],
      datasets: [
        {
          label: 'High-Value Customers',
          data: [3400, 1850, 2200, 1650, 1900],
          backgroundColor: 'rgba(40, 167, 69, 0.8)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 2,
          type: 'bar'
        },
        {
          label: 'Low-Value Customers',
          data: [2100, 850, 1200, 950, 1100],
          backgroundColor: 'rgba(255, 193, 7, 0.8)',
          borderColor: 'rgba(255, 193, 7, 1)',
          borderWidth: 2,
          type: 'bar'
        }
      ],
      yAxisLabel: 'Average Spend ($)'
    },
    'store': {
      labels: ['PHARMACY', 'SPIRITS', 'FROZEN', 'GROCERY', 'PRODUCE'],
      datasets: [
        {
          label: 'Urban Stores',
          data: [1850, 1200, 2100, 3400, 1650],
          backgroundColor: 'rgba(220, 53, 69, 0.8)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 2,
          type: 'bar'
        },
        {
          label: 'Suburban Stores',
          data: [950, 800, 2850, 2900, 1800],
          backgroundColor: 'rgba(23, 162, 184, 0.8)',
          borderColor: 'rgba(23, 162, 184, 1)',
          borderWidth: 2,
          type: 'bar'
        }
      ],
      yAxisLabel: 'Units Sold'
    },
    'season': {
      labels: ['Winter', 'Spring', 'Summer', 'Fall'],
      datasets: [
        {
          label: 'Total Sales',
          data: [1950, 1750, 2250, 2600],
          backgroundColor: 'rgba(255, 193, 7, 0.8)',
          borderColor: 'rgba(255, 193, 7, 1)',
          borderWidth: 2,
          type: 'bar'
        },
        {
          label: 'Average Basket Value',
          data: [65, 58, 70, 74],
          borderColor: 'rgba(13, 110, 253, 1)',
          backgroundColor: 'rgba(13, 110, 253, 0.2)',
          borderWidth: 3,
          type: 'line',
          fill: false
        }
      ],
      yAxisLabel: 'Sales / Basket Value'
    }
  };

  const apiData = currentAnalysisData?.[compareBy];
  const dataConfig = (apiData && apiData.labels && apiData.labels.length)
    ? apiData
    : fallbackMap[compareBy];

  const datasets = (dataConfig?.datasets || []).map(dataset => ({
    ...dataset,
    data: (dataset.data || []).map(value => Number(value))
  }));

  const defaultXAxis = compareBy === 'time'
    ? 'Time Periods'
    : compareBy === 'customer_segment'
      ? 'Product Categories'
      : compareBy === 'store'
        ? 'Product Categories'
        : 'Seasons';

  const yAxisLabel = dataConfig?.yAxisLabel || 'Value';

  charts.comparison = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dataConfig?.labels || [],
      datasets: datasets.length ? datasets : (fallbackMap[compareBy]?.datasets || [])
    },
    options: {
      maintainAspectRatio: false,
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: yAxisLabel,
            font: { weight: 'bold' }
          },
          ticks: {
            callback: function(value) {
              if (yAxisLabel.includes('$')) {
                return '$' + Number(value).toLocaleString();
              }
              return Number(value).toLocaleString();
            }
          }
        },
        x: {
          title: {
            display: true,
            text: dataConfig?.xAxisLabel || defaultXAxis,
            font: { weight: 'bold' }
          }
        }
      }
    }
  });
}

function generateDifferentialInsights() {
  const compareBy = document.getElementById('compareBy')?.value || 'time';
  const statTest = document.getElementById('statTest')?.value || 'chi_square';
  const statNote = document.getElementById('statNote');

  if (statNote) {
    statNote.textContent = 'Using curated sample insights. Run the analysis to refresh live statistics.';
  }

  const insightMap = {
    'time': [
      {
        title: 'Q4 Holiday Season Peak',
        description: 'FROZEN GROCERY shows 34% higher sales in Q4 vs Q2 (p < 0.01)',
        impact: 'High',
        recommendation: 'Increase frozen inventory 3 weeks before holidays',
        department: 'FROZEN GROCERY',
        commodity: 'Seasonal Demand',
        top_products: []
      },
      {
        title: 'Summer Beverage Surge',
        description: 'BEVERAGE department peaks in Q3 with 28% increase (p < 0.05)',
        impact: 'Medium',
        recommendation: 'Boost beverage promotions in summer months',
        department: 'BEVERAGE',
        commodity: 'Seasonal Demand',
        top_products: []
      }
    ],
    'customer_segment': [
      {
        title: 'Premium Customer Preferences',
        description: 'High-value customers purchase 2.3x more SPIRITS (Mann-Whitney U p < 0.001)',
        impact: 'High',
        recommendation: 'Create premium wine and spirits loyalty program',
        department: 'Customer Loyalty',
        commodity: 'SPIRITS',
        top_products: []
      },
      {
        title: 'Family Shopping Patterns',
        description: 'Families buy 1.8x more DAIRY and PRODUCE together (χ² = 45.2, p < 0.01)',
        impact: 'Medium',
        recommendation: 'Place dairy and produce sections adjacently',
        department: 'Customer Experience',
        commodity: 'DAIRY',
        top_products: []
      }
    ],
    'store': [
      {
        title: 'Urban vs Suburban Patterns',
        description: 'Urban stores have 45% higher PHARMACY sales (t-test p < 0.001)',
        impact: 'High',
        recommendation: 'Expand health sections in urban locations',
        department: 'PHARMACY SUPPLY',
        commodity: 'PHARMACY',
        top_products: []
      },
      {
        title: 'Location-Based Preferences',
        description: 'Suburban stores sell 60% more FROZEN items (p < 0.05)',
        impact: 'Medium',
        recommendation: 'Increase frozen food variety in suburban stores',
        department: 'FROZEN GROCERY',
        commodity: 'FROZEN ITEMS',
        top_products: []
      }
    ],
    'season': [
      {
        title: 'Winter Comfort Food Trend',
        description: 'BAKERY and DELI purchases increase 42% in winter months',
        impact: 'High',
        recommendation: 'Promote warm, comfort foods during cold seasons',
        department: 'BAKERY',
        commodity: 'Comfort Foods',
        top_products: []
      }
    ]
  };

  const insights = insightMap[compareBy] || insightMap['time'];
  const html = (insights || []).map(insight => renderDifferentialInsightCard(insight, compareBy, statTest)).join('');
  const container = document.getElementById('differentialInsights');
  if (container) {
    container.innerHTML = html || `
      <div class="col-12">
        <div class="text-center py-3 text-muted">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <p>No differential insights available.</p>
        </div>
      </div>
    `;
  }
}


function runDifferentialAnalysis() {
  const compareBy = document.getElementById('compareBy')?.value || 'time';
  const statTest = document.getElementById('statTest')?.value || 'chi_square';
  const statNote = document.getElementById('statNote');

  showNotification(`Running ${statTest.replace('_', ' ')} test for ${compareBy.replace('_', ' ')} comparison...`, 'info');

  if (statNote) {
    statNote.textContent = `Computing ${statTest.replace('_', ' ')} test using live data...`;
  }

  const container = document.getElementById('differentialInsights');
  if (container) {
    container.innerHTML = `
      <div class="col-12">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Running statistical analysis...</p>
          <small class="text-muted">Computing ${statTest.replace('_', ' ')} test...</small>
        </div>
      </div>
    `;
  }

  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!csrfToken) {
    console.error('CSRF token not found');
    showNotification('CSRF token missing. Please refresh the page.', 'error');
    generateDifferentialInsights();
    return;
  }

  const timeoutPromise = new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Request timeout')), 10000)
  );

  const fetchPromise = fetch('{% url "dunnhumby_site:api_differential_analysis" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrfToken.value
    },
    body: `compare_by=${compareBy}&stat_test=${statTest}`
  });

  Promise.race([fetchPromise, timeoutPromise])
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }

      const pValue = document.getElementById('pValue');
      const effectSize = document.getElementById('effectSize');
      const significance = document.getElementById('significance');

      if (pValue) {
        pValue.textContent = data.statistics?.p_value ?? '--';
      }
      if (effectSize) {
        effectSize.textContent = data.statistics?.effect_size ?? '--';
      }
      if (significance) {
        significance.textContent = data.statistics?.confidence ? `${data.statistics.confidence}%` : '--';
      }
      if (statNote) {
        const testLabel = (data.statistics?.test_type || statTest).replace('_', ' ');
        statNote.textContent = data.statistics?.note || `Completed ${testLabel} test.`;
      }

      if (data.chart && data.chart.labels) {
        currentAnalysisData[compareBy] = data.chart;
      } else {
        delete currentAnalysisData[compareBy];
      }

      generateDifferentialInsightsFromAPI(data.insights || [], compareBy, statTest);
      initializeComparisonChart();

      showNotification(`${statTest.replace('_', ' ')} analysis completed successfully!`, 'success');
    })
    .catch(error => {
      console.error('Differential Analysis API Error:', error);
      showNotification(`Using sample data - API issue: ${error.message}`, 'warning');

      delete currentAnalysisData[compareBy];
      generateDifferentialInsights();

      const pValue = document.getElementById('pValue');
      const effectSize = document.getElementById('effectSize');
      const significance = document.getElementById('significance');
      if (pValue) {
        pValue.textContent = (Math.random() * 0.049 + 0.001).toFixed(3);
      }
      if (effectSize) {
        effectSize.textContent = (Math.random() * 0.6 + 0.3).toFixed(2);
      }
      if (significance) {
        significance.textContent = '90%';
      }
      if (statNote) {
        statNote.textContent = 'Falling back to sample insights due to API timeout.';
      }

      initializeComparisonChart();
    });
}


function generateDifferentialInsightsFromAPI(insights, compareBy, statTest) {
  const html = (insights || []).map(insight => renderDifferentialInsightCard(insight, compareBy, statTest)).join('');
  const container = document.getElementById('differentialInsights');
  if (container) {
    container.innerHTML = html || `
      <div class="col-12">
        <div class="text-center py-3 text-muted">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <p>No significant differences found with current parameters.</p>
        </div>
      </div>
    `;
  }
}

function expandSection(sectionType) {
  let title, content, container;
  
  switch(sectionType) {
    case 'department':
      title = 'All Department Level Association Rules';
      container = document.getElementById('associationRules');
      break;
    case 'commodity':
      title = 'All Commodity Level Association Rules';
      container = document.getElementById('associationRulesCommodity');
      break;
    case 'baskets':
      title = 'All High-Value Baskets';
      container = document.getElementById('basketsGrid');
      break;
    case 'recommendations':
      title = 'All AI-Powered Product Recommendations';
      container = document.getElementById('recommendedProducts');
      break;
    case 'differential':
      title = 'All Differential Analysis Insights';
      container = document.getElementById('differentialInsights');
      break;
  }
  
  if (container) {
    let content = container.innerHTML;
    
    // For baskets, recommendations, and differential, wrap in proper bootstrap grid
    if (sectionType === 'baskets' || sectionType === 'recommendations' || sectionType === 'differential') {
      content = `<div class="row g-3">${content}</div>`;
    }
    
    const modalContent = `
      <div id="expandedContent" style="max-height: 70vh; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
        ${content}
      </div>
    `;
    
    showDetailModal(title, modalContent);
    
    // Re-attach event listeners after modal is shown
    setTimeout(() => {
      attachPopupEventListeners(sectionType);
    }, 200);
  }
}

// Attach event listeners to popup content
function attachPopupEventListeners(sectionType) {
  const expandedContent = document.getElementById('expandedContent');
  if (!expandedContent) return;
  
  if (sectionType === 'baskets') {
    // Attach basket card click handlers
    const basketCards = expandedContent.querySelectorAll('.basket-card');
    basketCards.forEach(card => {
      card.style.cursor = 'pointer';
      card.addEventListener('click', async function() {
        const basketId = this.dataset.basketId;
        if (!basketId) return;
        
        showNotification('Loading basket details...', 'info');
        
        try {
          const csrftoken = (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1]||'';
          const formData = new FormData();
          formData.append('csrfmiddlewaretoken', csrftoken);
          formData.append('basket_id', basketId);
          
          const response = await fetch('/analysis/api/basket/', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          if (data.error) {
            showDetailModal(`Basket ${basketId}`, `<div class="alert alert-danger">${data.error}</div>`);
            return;
          }
          
          let content = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>Product</th><th>Quantity</th><th>Sales Value</th><th>Department</th></tr></thead><tbody>';
          
          (data.items || []).forEach(item => {
            const dept = item.department || 'MISC. TRANS.';
            content += `<tr>
              <td><strong>${item.product_id}</strong><br><small class="text-muted">${item.commodity_desc || ''}</small></td>
              <td>${item.quantity}</td>
              <td>$${Number(item.sales_value || 0).toFixed(2)}</td>
              <td>${createDepartmentBadge(dept)}</td>
            </tr>`;
          });
          
          content += '</tbody></table></div>';
          showDetailModal(`🛒 Basket #${basketId} Details`, content);
          
        } catch (error) {
          showNotification('Failed to load basket details', 'error');
        }
      });
    });
  } else if (sectionType === 'recommendations') {
    // Force re-initialization of recommendation cards in modal
    setTimeout(() => {
      const cards = expandedContent.querySelectorAll('.recommendation-card');
      console.log(`Found ${cards.length} recommendation cards in expanded modal`);

      cards.forEach((card, index) => {
        // Remove existing listener flag to force re-attachment
        card.dataset.listenerAttached = 'false';
        card.style.cursor = 'pointer';

        // Clone card to remove all existing event listeners
        const newCard = card.cloneNode(true);
        card.parentNode.replaceChild(newCard, card);
      });

      // Re-initialize with fresh cards
      initializeRecommendationCards(expandedContent);
      console.log('Recommendation cards re-initialized in modal');
    }, 100);
  } else if (sectionType === 'differential') {
    // Attach differential insight card click handlers
    const insightCards = expandedContent.querySelectorAll('.differential-insight-card');
    insightCards.forEach(card => {
      card.style.cursor = 'pointer';
      card.addEventListener('click', function() {
        showDifferentialInsightDetailsFromCard(this);
      });
    });
  } else {
    // Attach rule card click handlers for department and commodity rules
    const ruleCards = expandedContent.querySelectorAll('.rule-card');
    ruleCards.forEach(card => {
      card.style.cursor = 'pointer';
      // Extract data from the card's onclick attribute or recreate the click handler
      const onclickAttr = card.getAttribute('onclick');
      if (onclickAttr) {
        // Parse the onclick parameters
        const match = onclickAttr.match(/showRuleDetails\('([^']+)',\s*'([^']+)',\s*([\d.]+),\s*([\d.]+),\s*([\d.]+),\s*'([^']+)'\)/);
        if (match) {
          const [, antecedent, consequent, support, confidence, lift, ruleType] = match;
          card.addEventListener('click', function() {
            showRuleDetails(antecedent, consequent, parseFloat(support), parseFloat(confidence), parseFloat(lift), ruleType);
          });
        }
      }
    });
  }
}

// Remove the scrollToSection function since we removed the scroll buttons

// Configuration helper functions
function updateComparisonDescription() {
  const compareBy = document.getElementById('compareBy')?.value;
  const description = document.getElementById('compareByDescription');
  const previewText = document.getElementById('previewText');

  const descriptions = {
    'time': 'Compare shopping patterns across different time quarters to identify seasonal trends and temporal changes.',
    'customer_segment': 'Analyze differences between high-value and low-value customer shopping behaviors and preferences.',
    'store': 'Compare purchasing patterns between urban and suburban store locations to understand regional differences.',
    'season': 'Examine how weather and seasonal changes impact product category demands and shopping trends.'
  };

  if (description) description.textContent = descriptions[compareBy] || descriptions['time'];
  updateAnalysisPreview();
}

function updateStatTestDescription() {
  const statTest = document.getElementById('statTest')?.value;
  const description = document.getElementById('statTestDescription');

  const descriptions = {
    'chi_square': 'Tests if category frequencies differ significantly between groups. Best for comparing product category distributions.',
    't_test': 'Compares average values between two groups. Ideal for analyzing differences in sales amounts, basket sizes, or quantities.',
    'mann_whitney': 'Non-parametric test for comparing groups when data is not normally distributed. Robust for skewed sales data.',
    'kolmogorov': 'Tests if two groups have different probability distributions. Useful for comparing overall shopping pattern distributions.'
  };

  if (description) description.textContent = descriptions[statTest] || descriptions['chi_square'];
  updateAnalysisPreview();
}

function updateAnalysisPreview() {
  const compareBy = document.getElementById('compareBy')?.value || 'time';
  const statTest = document.getElementById('statTest')?.value || 'chi_square';
  const previewText = document.getElementById('previewText');

  const comparisons = {
    'time': 'different time quarters',
    'customer_segment': 'high-value vs low-value customers',
    'store': 'urban vs suburban store locations',
    'season': 'different seasonal periods'
  };

  const tests = {
    'chi_square': 'Chi-Square test to identify statistically significant differences in product category preferences',
    't_test': 'T-Test to compare average sales values and quantities between groups',
    'mann_whitney': 'Mann-Whitney U test to analyze non-parametric differences in shopping behaviors',
    'kolmogorov': 'Kolmogorov-Smirnov test to compare overall shopping pattern distributions'
  };

  if (previewText) {
    previewText.textContent = `Will compare shopping patterns between ${comparisons[compareBy]} using ${tests[statTest]}.`;
  }
}

function showConfigurationHelp() {
  const helpContent = `
    <div class="configuration-help">
      <h6 class="text-primary mb-3"><i class="fas fa-info-circle"></i> Differential Analysis Configuration Guide</h6>

      <div class="row">
        <div class="col-md-6">
          <h6 class="fw-bold mb-2">Compare By Options:</h6>
          <div class="help-option mb-2">
            <strong>📅 Time Periods:</strong>
            <small class="d-block text-muted">Compare Q1, Q2, Q3, Q4 patterns to identify seasonal trends, holiday impacts, and temporal shifts in customer preferences.</small>
          </div>
          <div class="help-option mb-2">
            <strong>👥 Customer Segments:</strong>
            <small class="d-block text-muted">Analyze high-value vs low-value customer behaviors to understand premium preferences and budget shopping patterns.</small>
          </div>
          <div class="help-option mb-2">
            <strong>🏪 Store Locations:</strong>
            <small class="d-block text-muted">Compare urban vs suburban shopping patterns to identify regional preferences and demographic influences.</small>
          </div>
          <div class="help-option">
            <strong>🌤️ Seasonal Patterns:</strong>
            <small class="d-block text-muted">Examine weather and seasonal impacts on product demands, including comfort foods and seasonal items.</small>
          </div>
        </div>

        <div class="col-md-6">
          <h6 class="fw-bold mb-2">Statistical Test Options:</h6>
          <div class="help-option mb-2">
            <strong>χ² Chi-Square Test:</strong>
            <small class="d-block text-muted">Best for comparing category frequencies and product distribution differences between groups.</small>
          </div>
          <div class="help-option mb-2">
            <strong>📊 T-Test:</strong>
            <small class="d-block text-muted">Ideal for comparing average values like sales amounts, basket sizes, or purchase quantities.</small>
          </div>
          <div class="help-option mb-2">
            <strong>📈 Mann-Whitney U:</strong>
            <small class="d-block text-muted">Non-parametric test for skewed data, robust for real-world sales distributions.</small>
          </div>
          <div class="help-option">
            <strong>📉 Kolmogorov-Smirnov:</strong>
            <small class="d-block text-muted">Tests if two groups have fundamentally different shopping pattern distributions.</small>
          </div>
        </div>
      </div>

      <div class="alert alert-success mt-3">
        <small><strong>💡 Manager's Tip:</strong> Start with Time Periods + Chi-Square for easy-to-understand seasonal trends, then explore Customer Segments + T-Test for value-based insights.</small>
      </div>
    </div>
  `;

  showDetailModal('Configuration Help', helpContent);
}

// Show detailed differential insight information

function showDifferentialInsightDetailsFromCard(cardElement) {
  if (!cardElement) {
    return;
  }

  const title = cardElement.dataset.insightTitle || '';
  const description = cardElement.dataset.insightDescription || '';
  const impact = cardElement.dataset.insightImpact || 'Medium';
  const recommendation = cardElement.dataset.insightRecommendation || '';
  const compareBy = cardElement.dataset.compareBy || 'time';
  const statTest = cardElement.dataset.statTest || 'chi_square';
  let topProducts = [];

  if (cardElement.dataset.products) {
    try {
      topProducts = JSON.parse(decodeURIComponent(cardElement.dataset.products)) || [];
    } catch (error) {
      console.warn('Unable to parse product details for insight card', error);
      topProducts = [];
    }
  }

  showDifferentialInsightDetails(title, description, impact, recommendation, compareBy, statTest, topProducts);
}


function showDifferentialInsightDetails(title, description, impact, recommendation, compareBy, statTest, topProducts = []) {
  const impactColor = impact === 'High' ? '#dc3545' : '#ffc107';
  const impactIcon = impact === 'High' ? '⚠️' : '⚡';

  const comparisonName = compareBy.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
  const testName = statTest.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());

  const safeTitle = escapeHtml(title);
  const safeDescription = escapeHtml(description);
  const safeImpact = escapeHtml(impact);
  const safeRecommendation = escapeHtml(recommendation);
  const safeComparisonName = escapeHtml(comparisonName);
  const safeTestName = escapeHtml(testName);

  const productDetails = Array.isArray(topProducts) ? topProducts.slice(0, 6) : [];
  const productSection = productDetails.length ? `
      <div class="row mb-4">
        <div class="col-12">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #0dcaf0;">
            <h6 style="color: #0c5460; margin-bottom: 1rem;"><i class="fas fa-boxes"></i> Products Influencing This Difference</h6>
            <div class="row g-3">
              ${productDetails.map(product => {
                const name = escapeHtml(product.name || product.commodity || `Product ${product.product_id || ''}`);
                const sales = Number(product.sales || 0).toFixed(2);
                const quantity = Number(product.quantity || 0).toLocaleString();
                const share = product.share !== undefined && product.share !== null
                  ? `${Number(product.share).toFixed(1)}%`
                  : null;
                return `
                  <div class="col-md-6">
                    <div style="background: #ffffff; border-radius: 12px; padding: 1rem; border: 1px solid #e2e8f0;">
                      <div style="font-weight: 600; color: #2d3748;">${name}</div>
                      <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.35rem; display: flex; flex-wrap: wrap; gap: 8px;">
                        <span><i class="fas fa-dollar-sign"></i> $${sales}</span>
                        <span><i class="fas fa-shopping-cart"></i> ${quantity} units</span>
                        ${share ? `<span><i class="fas fa-percentage"></i> ${share}</span>` : ''}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      </div>
  ` : '';

  let additionalInsights = '';
  let actionItems = '';

  if (compareBy === 'time') {
    additionalInsights = `
      <li><strong>Seasonality Pattern:</strong> This trend shows recurring seasonal behavior that can be leveraged for inventory planning</li>
      <li><strong>Marketing Window:</strong> Consider launching targeted campaigns 2-3 weeks before peak periods</li>
      <li><strong>Supply Chain Impact:</strong> Adjust supplier orders and warehouse capacity based on these temporal patterns</li>
    `;
    actionItems = `
      <li>📊 Update quarterly forecasting models with this insight</li>
      <li>📋 Review current inventory allocation strategies</li>
      <li>🎯 Plan seasonal marketing campaigns in advance</li>
    `;
  } else if (compareBy === 'customer_segment') {
    additionalInsights = `
      <li><strong>Customer Value:</strong> Understanding segment preferences helps optimize product placement and pricing</li>
      <li><strong>Loyalty Opportunity:</strong> Target high-value segments with personalized offers and premium product lines</li>
      <li><strong>Market Expansion:</strong> Identify opportunities to move low-value customers to higher spending categories</li>
    `;
    actionItems = `
      <li>👥 Create targeted customer loyalty programs</li>
      <li>💰 Develop premium product placement strategies</li>
      <li>📈 Design customer value migration campaigns</li>
    `;
  } else if (compareBy === 'store') {
    additionalInsights = `
      <li><strong>Location Strategy:</strong> Store location significantly impacts product demand and customer preferences</li>
      <li><strong>Demographic Influence:</strong> Urban vs suburban differences reflect lifestyle and accessibility factors</li>
      <li><strong>Operational Efficiency:</strong> Tailor store layouts and inventory to location-specific patterns</li>
    `;
    actionItems = `
      <li>🏪 Customize store layouts by location type</li>
      <li>🚚 Optimize delivery and logistics strategies</li>
      <li>📍 Consider location factors in new store planning</li>
    `;
  } else {
    additionalInsights = `
      <li><strong>Weather Impact:</strong> Seasonal patterns reflect natural demand cycles and weather influences</li>
      <li><strong>Cultural Factors:</strong> Holiday and seasonal traditions drive predictable shopping behaviors</li>
      <li><strong>Product Lifecycle:</strong> Understand when products naturally peak and decline in demand</li>
    `;
    actionItems = `
      <li>🌤️ Integrate weather forecasting in demand planning</li>
      <li>🎭 Plan seasonal product promotions and clearances</li>
      <li>📦 Optimize seasonal inventory turnover</li>
    `;
  }

  const body = `
    <div class="differential-insight-details" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="detail-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px;">
            <h4 style="margin: 0 0 0.5rem 0; font-weight: 600;">${safeTitle}</h4>
            <p style="margin: 0; opacity: 0.9; line-height: 1.4;">${safeDescription}</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="detail-card" style="background: linear-gradient(135deg, ${impactColor}, ${impactColor}dd); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
            <h4 style="margin: 0; font-weight: 600;">Impact Level</h4>
            <h2 style="margin: 0.5rem 0; font-size: 2.5rem;">${impactIcon}</h2>
            <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700;">${safeImpact}</h3>
          </div>
        </div>
      </div>

      ${productSection}

      <div class="row mb-4">
        <div class="col-md-6">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #007bff;">
            <h6 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-chart-bar"></i> Statistical Analysis</h6>
            <p style="color: #6c757d; margin: 0;"><strong>Method:</strong> ${safeTestName}</p>
            <small style="color: #6c757d;">Comparing patterns between ${safeComparisonName.toLowerCase()}</small>
          </div>
        </div>
        <div class="col-md-6">
          <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 1.5rem; border-radius: 10px;">
            <h6 style="margin: 0 0 1rem 0;"><i class="fas fa-lightbulb"></i> Primary Recommendation</h6>
            <p style="margin: 0; line-height: 1.4; font-weight: 500;">${safeRecommendation}</p>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div style="background: #e9ecef; padding: 1.5rem; border-radius: 10px;">
            <h6 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-microscope"></i> Business Implications</h6>
            <ul style="color: #6c757d; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
              ${additionalInsights}
            </ul>
          </div>
        </div>
      </div>

      <div style="background: linear-gradient(135deg, #ffc107, #ffb300); color: #212529; padding: 1.5rem; border-radius: 10px;">
        <h6 style="margin-bottom: 1rem;"><i class="fas fa-tasks"></i> Recommended Action Items</h6>
        <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.6;">
          ${actionItems}
          <li>📊 Monitor this pattern over the next reporting period</li>
          <li>🔍 Investigate underlying causes and additional correlations</li>
        </ul>
      </div>
    </div>
  `;

  showDetailModal(`${impactIcon} Differential Analysis Insight`, body);
}


function showRecommendationDetails(
  productId,
  department,
  commodity,
  confidence,
  revenueImpact,
  manufacturer,
  brand,
  subCommodity,
  size,
  customerCount,
  avgValue,
  totalValue,
  totalQuantity
) {
  const title = `🛒 Product Recommendation Details`;

  const parsedConfidence = parseFloat(confidence || 0);
  const confidencePercent = (parsedConfidence * 100).toFixed(1);
  const formattedRevenue = revenueImpact ? `$${Number(revenueImpact).toLocaleString()}` : 'N/A';

  const normalizedDepartment = department && department !== 'undefined' && department !== '' ? department : 'MISC. TRANS.';
  const normalizedCommodity = commodity && commodity !== 'undefined' && commodity !== '' ? commodity : 'All Products';
  const normalizedBrand = brand && brand !== 'undefined' && brand !== '' ? brand : 'Unknown Brand';
  const normalizedManufacturer = manufacturer && manufacturer !== 'undefined' && manufacturer !== '' ? manufacturer : 'Not Provided';
  const normalizedSubCommodity = subCommodity && subCommodity !== 'undefined' && subCommodity !== '' ? subCommodity : 'N/A';
  const normalizedSize = size && size !== 'undefined' && size !== '' ? size : 'N/A';

  const deptBadge = createDepartmentBadge(normalizedDepartment);
  const commodityBadge = createCommodityBadge(normalizedCommodity);

  const safeProductId = escapeHtml(productId || 'N/A');
  const displayBrand = escapeHtml(normalizedBrand);
  const displayManufacturer = escapeHtml(normalizedManufacturer);
  const displaySubCommodity = escapeHtml(normalizedSubCommodity);
  const displaySize = escapeHtml(normalizedSize);
  const displayCommodity = escapeHtml(normalizedCommodity);

  const householdsNum = customerCount ? parseInt(customerCount, 10) || 0 : 0;
  const avgValueNum = avgValue ? parseFloat(avgValue) || 0 : 0;
  const totalValueNum = totalValue ? parseFloat(totalValue) || 0 : 0;
  const totalQuantityNum = totalQuantity ? parseFloat(totalQuantity) || 0 : 0;

  const households = householdsNum.toLocaleString();
  const formattedAvgValue = `$${avgValueNum.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const formattedTotalValue = `$${totalValueNum.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const formattedTotalQuantity = totalQuantityNum.toLocaleString();
  const revenuePerUnitValue = totalQuantityNum > 0 ? totalValueNum / totalQuantityNum : null;
  const formattedRevenuePerUnit = revenuePerUnitValue !== null ? `$${revenuePerUnitValue.toFixed(2)}` : 'N/A';
  const subtitleText = normalizedSubCommodity !== 'N/A' ? `${displayCommodity} • ${displaySubCommodity}` : displayCommodity;

  const commodityLowerEscaped = escapeHtml(normalizedCommodity.toLowerCase());
  const subCommodityLowerEscaped = normalizedSubCommodity !== 'N/A' ? escapeHtml(normalizedSubCommodity.toLowerCase()) : '';
  const departmentEscaped = escapeHtml(normalizedDepartment);

  let confidenceLevel = 'Low';
  let confidenceColor = '#dc3545';
  let confidenceDesc = `This recommendation has low confidence. Consider additional validation before expanding <strong>${displayBrand}</strong>.`;

  if (parsedConfidence >= 0.8) {
    confidenceLevel = 'Very High';
    confidenceColor = '#28a745';
    confidenceDesc = `<strong>${displayBrand}</strong> shows very strong predictive signals with consistent purchase behavior across engaged households.`;
  } else if (parsedConfidence >= 0.65) {
    confidenceLevel = 'High';
    confidenceColor = '#20c997';
    confidenceDesc = `Predictive indicators for <strong>${displayBrand}</strong> are reliable and align well with recent shopping patterns.`;
  } else if (parsedConfidence >= 0.5) {
    confidenceLevel = 'Medium';
    confidenceColor = '#ffc107';
    confidenceDesc = `<strong>${displayBrand}</strong> has moderate confidence. Pair with supporting campaigns and monitor response closely.`;
  }

  const strategyPromo = parsedConfidence >= 0.7
    ? '<li>This high-confidence recommendation is ideal for feature placement and promotional campaigns.</li>'
    : '<li>Run controlled tests before scaling major promotions to confirm shopper response.</li>';

  const body = `
    <div class="recommendation-details" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="detail-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
            <h4 style="margin: 0; font-weight: 600;">Product ID</h4>
            <h2 style="margin: 0.5rem 0 0 0; font-size: 2.5rem; font-weight: 700;">${safeProductId}</h2>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-card" style="background: linear-gradient(135deg, ${confidenceColor}, ${confidenceColor}dd); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
            <h4 style="margin: 0; font-weight: 600;">Confidence</h4>
            <h2 style="margin: 0.5rem 0 0 0; font-size: 2.5rem; font-weight: 700;">${confidencePercent}%</h2>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">${confidenceLevel}</p>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #007bff;">
            <h5 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-building"></i> Department</h5>
            <div>${deptBadge}</div>
          </div>
        </div>
        <div class="col-md-6">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #28a745;">
            <h5 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-boxes"></i> Commodity Profile</h5>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              ${commodityBadge}
              <span style="color: #6c757d; font-size: 0.85rem;">${subtitleText}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #6610f2;">
            <h5 style="color: #495057; margin-bottom: 0.75rem;"><i class="fas fa-tag"></i> Brand & Manufacturer</h5>
            <p style="margin: 0; color: #495057;"><strong>Brand:</strong> ${displayBrand}</p>
            <p style="margin: 0.35rem 0 0 0; color: #495057;"><strong>Manufacturer:</strong> ${displayManufacturer}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #fd7e14;">
            <h5 style="color: #495057; margin-bottom: 0.75rem;"><i class="fas fa-ruler-combined"></i> Product Attributes</h5>
            <p style="margin: 0; color: #495057;"><strong>Size / Pack:</strong> ${displaySize}</p>
            <p style="margin: 0.35rem 0 0 0; color: #495057;"><strong>Sub-Commodity:</strong> ${displaySubCommodity}</p>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 1.5rem; border-radius: 10px; text-align: center;">
            <h5 style="margin: 0 0 0.5rem 0;"><i class="fas fa-dollar-sign"></i> Predicted Revenue Impact</h5>
            <h3 style="margin: 0; font-size: 2rem; font-weight: 700;">${formattedRevenue}</h3>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">Estimated additional revenue from this recommendation</p>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-sm-6 col-lg-3">
          <div style="background: #f8f9fa; padding: 1.25rem; border-radius: 12px; border-left: 4px solid #6366f1;">
            <h6 style="margin: 0; color: #4b5563; font-weight: 600;">Household Reach</h6>
            <h3 style="margin: 0.5rem 0; color: #1f2937;">${households}</h3>
            <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Unique shoppers purchasing this item</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div style="background: #f8f9fa; padding: 1.25rem; border-radius: 12px; border-left: 4px solid #0d6efd;">
            <h6 style="margin: 0; color: #4b5563; font-weight: 600;">Total Sales Value</h6>
            <h3 style="margin: 0.5rem 0; color: #1f2937;">${formattedTotalValue}</h3>
            <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Historical sales captured in the dataset</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div style="background: #f8f9fa; padding: 1.25rem; border-radius: 12px; border-left: 4px solid #198754;">
            <h6 style="margin: 0; color: #4b5563; font-weight: 600;">Total Units Sold</h6>
            <h3 style="margin: 0.5rem 0; color: #1f2937;">${formattedTotalQuantity}</h3>
            <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Units purchased across all baskets</p>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div style="background: #f8f9fa; padding: 1.25rem; border-radius: 12px; border-left: 4px solid #fd7e14;">
            <h6 style="margin: 0; color: #4b5563; font-weight: 600;">Avg Basket Value</h6>
            <h3 style="margin: 0.5rem 0; color: #1f2937;">${formattedAvgValue}</h3>
            <p style="margin: 0; font-size: 0.8rem; color: #6b7280;">Average spend when this product is included</p>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div style="background: #fef9ef; padding: 1.25rem; border-radius: 12px; border-left: 4px solid #ffc107;">
            <h6 style="margin: 0 0 0.75rem 0; color: #84550a; font-weight: 600;"><i class="fas fa-balance-scale"></i> Revenue per Unit</h6>
            <p style="margin: 0; color: #6c757d; line-height: 1.5;">Average revenue per unit: <strong>${formattedRevenuePerUnit}</strong>. Use this to evaluate pricing and promotional discounts without eroding margin.</p>
          </div>
        </div>
      </div>

      <div style="background: #e9ecef; padding: 1.5rem; border-radius: 10px;">
        <h5 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-lightbulb"></i> AI Analysis</h5>
        <p style="color: #6c757d; margin-bottom: 1rem; line-height: 1.6;">${confidenceDesc} Household spend averages ${formattedAvgValue} with lifetime sales of ${formattedTotalValue}, supporting the predicted lift of ${formattedRevenue}.</p>

        <h6 style="color: #495057; margin-bottom: 0.5rem;">Recommendation Strategy:</h6>
        <ul style="color: #6c757d; margin: 0; padding-left: 1.5rem;">
          <li>Spotlight <strong>${displayBrand}</strong> within the <strong>${departmentEscaped}</strong> aisle using merchandising that highlights the ${displaySize} pack.</li>
          <li>Bundle with complementary ${commodityLowerEscaped}${subCommodityLowerEscaped ? ` / ${subCommodityLowerEscaped}` : ''} items to drive cross-basket value.</li>
          <li>Coordinate with <strong>${displayManufacturer}</strong> on co-branded offers that leverage the ${formattedRevenue} upside.</li>
          <li>Engage the ${households} households already purchasing this item with personalized follow-up campaigns.</li>
          ${strategyPromo}
        </ul>
      </div>
    </div>
  `;

  showDetailModal(title, body);
}

// Show detailed rule information
function showRuleDetails(antecedent, consequent, support, confidence, lift, ruleType) {
  const isDepth = ruleType === 'department';
  const antBadge = isDepth ? createDepartmentBadge(antecedent) : createCommodityBadge(antecedent);
  const conBadge = isDepth ? createDepartmentBadge(consequent) : createCommodityBadge(consequent);
  
  const interpretation = getInterpretation(support, confidence, lift);
  const businessValue = getBusinessValue(antecedent, consequent, lift, ruleType);
  
  const title = `${antecedent} → ${consequent}`;
  const body = `
    <div class="row g-3">
      <div class="col-12">
        <div class="text-center mb-3">
          <div class="d-flex align-items-center justify-content-center gap-3">
            ${antBadge}
            <i class="fas fa-arrow-right fa-2x text-primary"></i>
            ${conBadge}
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <div class="fs-3 fw-bold text-primary">${(support * 100).toFixed(1)}%</div>
            <div class="text-muted">Support</div>
            <small class="text-muted">How often both items appear together</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <div class="fs-3 fw-bold text-success">${(confidence * 100).toFixed(1)}%</div>
            <div class="text-muted">Confidence</div>
            <small class="text-muted">When ${antecedent} is bought, likelihood of buying ${consequent}</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <div class="fs-3 fw-bold text-warning">${lift}</div>
            <div class="text-muted">Lift</div>
            <small class="text-muted">${lift > 1 ? 'Strong positive' : lift == 1 ? 'Independent' : 'Negative'} association</small>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-chart-line"></i> Rule Interpretation</h6>
          </div>
          <div class="card-body">
            <p class="mb-2"><strong>Statistical Significance:</strong> ${interpretation.significance}</p>
            <p class="mb-2"><strong>Business Meaning:</strong> ${interpretation.meaning}</p>
            <p class="mb-0"><strong>Recommendation:</strong> ${interpretation.recommendation}</p>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Business Value</h6>
          </div>
          <div class="card-body">
            <p class="mb-2"><strong>Cross-selling Opportunity:</strong> ${businessValue.crossSell}</p>
            <p class="mb-2"><strong>Store Layout:</strong> ${businessValue.layout}</p>
            <p class="mb-0"><strong>Marketing Strategy:</strong> ${businessValue.marketing}</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showDetailModal(title, body);
}

// Get interpretation based on metrics
function getInterpretation(support, confidence, lift) {
  let significance, meaning, recommendation;
  
  if (lift > 2) {
    significance = "Very strong association - much more likely to be purchased together than by chance";
    meaning = "These items have a powerful synergistic relationship in customer behavior";
    recommendation = "Priority for cross-selling campaigns and strategic product placement";
  } else if (lift > 1.5) {
    significance = "Strong association - significantly more likely to be purchased together";
    meaning = "Customers frequently buy these items as complementary products";
    recommendation = "Good candidate for bundling promotions and adjacent placement";
  } else if (lift > 1) {
    significance = "Moderate positive association - somewhat more likely together than separately";
    meaning = "Some connection exists between these items in customer purchasing patterns";
    recommendation = "Consider testing promotional strategies and placement optimization";
  } else {
    significance = "Weak or no association - may be purchased independently";
    meaning = "These items don't show strong purchasing correlation";
    recommendation = "Focus on individual item optimization rather than cross-selling";
  }
  
  return { significance, meaning, recommendation };
}

// Get business value insights
function getBusinessValue(ant, con, lift, type) {
  const crossSell = lift > 1.5 ? 
    `High potential - customers buying ${ant} are ${lift}x more likely to buy ${con}` :
    `Moderate potential - some correlation exists between these items`;
    
  const layout = lift > 1.5 ? 
    `Place these items near each other or in the same aisle for maximum impact` :
    `Current placement is likely adequate, minor adjustments may help`;
    
  const marketing = lift > 2 ? 
    `Bundle these items in promotions, create combo deals, target customers who buy one with ads for the other` :
    `Consider seasonal promotions or targeted email campaigns highlighting the relationship`;
    
  return { crossSell, layout, marketing };
}

// Basket card interactions
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1]||'';

  // Initialize descriptive analysis by default
  loadDescriptiveAnalysis();

  // Wire up Prediction Horizon selector change handler
  const horizonSelect = document.getElementById('predictionHorizon');
  if (horizonSelect) {
    horizonSelect.addEventListener('change', () => {
      const algorithmSelect = document.getElementById('mlAlgorithm');
      const algorithmValue = algorithmSelect ? algorithmSelect.value : 'neural_network';
      const horizonValue = getSelectedHorizon();
      const horizonLabelText = getHorizonLabel(horizonValue).toLowerCase();
      showNotification('Updating forecasts for ' + horizonLabelText + ' horizon...', 'info');

      // Refresh predictions and recommendations with new horizon
      loadPredictiveResults(algorithmValue);
      generateRecommendations();
    });
  }
  
  // Basket card clicks
  document.querySelectorAll('.basket-card').forEach(card => {
    card.addEventListener('click', async function() {
      const basketId = this.dataset.basketId;
      showNotification('Loading basket details...', 'info');
      
      try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrftoken);
        formData.append('basket_id', basketId);
        
        const response = await fetch('/analysis/api/basket/', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
          showDetailModal(`Basket ${basketId}`, `<div class="alert alert-danger">${data.error}</div>`);
          return;
        }
        
        let content = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>Product</th><th>Quantity</th><th>Sales Value</th><th>Department</th></tr></thead><tbody>';
        
        (data.items || []).forEach(item => {
          const dept = item.department || 'MISC. TRANS.';
          content += `<tr>
            <td><strong>${item.product_id}</strong><br><small class="text-muted">${item.commodity_desc || ''}</small></td>
            <td>${item.quantity}</td>
            <td>$${Number(item.sales_value || 0).toFixed(2)}</td>
            <td>${createDepartmentBadge(dept)}</td>
          </tr>`;
        });
        
        content += '</tbody></table></div>';
        showDetailModal(`🛒 Basket #${basketId} Details`, content);
        
      } catch (error) {
        showNotification('Failed to load basket details', 'error');
      }
    });
  });
});

// Helper functions for ML integration
function getCsrfToken() {
  return (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1]||'';
}

// Simple modal function to prevent errors
function showDetailModal(title, content) {
  // Simple alert fallback - much more reliable than complex modal
  const cleanContent = content.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ');
  alert(title + '\n\n' + cleanContent);
}

// Prediction Horizon helper functions
function getSelectedHorizon() {
  const select = document.getElementById('predictionHorizon');
  const value = select ? parseInt(select.value, 10) : NaN;
  if ([1, 3, 6, 12].includes(value)) {
    return value;
  }
  return 3; // Default to 3 months
}

function getHorizonLabel(months) {
  const value = Number(months);
  if (value === 1) return '1 Month';
  if (value === 3) return '3 Months';
  if (value === 6) return '6 Months';
  if (value === 12) return '12 Months';
  return `${value || 3} Months`;
}

function updatePredictiveCharts(predictions, algorithm) {
  const timeHorizon = getSelectedHorizon();
  const horizonLabel = getHorizonLabel(timeHorizon);
  console.log('updatePredictiveCharts called with algorithm:', algorithm, 'horizon:', horizonLabel);
  console.log('Predictions data structure:', predictions);
  console.log('Number of predictions:', predictions ? predictions.length : 0);

  if (!predictions || predictions.length === 0) {
    console.error('No predictions provided - using only real data, no fallbacks!');
    showChartError('No real predictions available from the trained model.');
    return;
  }

  // Update chart titles to show current time horizon
  const revenueTitle = document.querySelector('#revenueImpactChart').parentElement.querySelector('h5');
  const trendsTitle = document.querySelector('#purchaseTrendsChart').parentElement.querySelector('h5');
  if (revenueTitle) {
    revenueTitle.innerHTML = `<i class="fas fa-chart-bar"></i> Revenue Impact by Department (${horizonLabel})`;
  }
  if (trendsTitle) {
    trendsTitle.innerHTML = `<i class="fas fa-calendar-alt"></i> Purchase Probability Trends (${horizonLabel})`;
  }

  // Validate that we have real data structure
  const firstPred = predictions[0];
  console.log('First prediction sample:', firstPred);

  if (!firstPred.department || !firstPred.customers || !firstPred.avg_value) {
    console.error('Invalid prediction data structure - missing required fields');
    showChartError('Invalid data structure received from database.');
    return;
  }

  // Get top 6 departments by predicted revenue (used by both charts)
  const topDepts = predictions.slice(0, 6);
  console.log('Top departments for charts:', topDepts);

  // Update Revenue Impact Chart
  const revenueContainer = document.getElementById('revenueImpactChart');
  if (revenueContainer) {

    // Use the time-horizon specific revenue forecast from the backend
    const revenueData = topDepts.map(p => {
      // Validate we have real data and selected forecast
      if (!p.selected_forecast || !p.selected_forecast.revenue_forecast) {
        console.error(`Missing selected forecast data for ${p.department}:`, p);
        return 0;
      }

      const revenue = parseFloat(p.selected_forecast.revenue_forecast);
      const horizonLabel = p.selected_forecast.label || 'Unknown';
      const months = p.selected_forecast.months || 0;

      console.log(`HORIZON-SPECIFIC DATA - ${p.department} (${horizonLabel}): $${revenue.toFixed(0)} revenue for ${months}-month forecast`);
      return Math.round(revenue);
    });
    const labels = topDepts.map(p => p.department);
    const colors = topDepts.map(p => DEPARTMENT_CONFIG[p.department]?.color || '#6C757D');

    console.log('Revenue data for chart:', revenueData);
    console.log('Chart labels:', labels);

    revenueContainer.innerHTML = `<canvas id="revenueChart" height="250"></canvas>`;
    const ctx = document.getElementById('revenueChart');

    if (charts.revenue) charts.revenue.destroy();
    charts.revenue = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Predicted Revenue Impact ($)',
          data: revenueData,
          backgroundColor: colors.map(c => c + '80'), // Add transparency
          borderColor: colors,
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: `${algorithm.replace('_', ' ').toUpperCase()} Model Revenue Predictions`,
            font: { size: 14, weight: 'bold' },
            color: '#2d3748'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Revenue Impact: $${context.parsed.y.toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Predicted Revenue ($)',
              color: '#4a5568',
              font: { weight: 'bold' }
            },
            ticks: {
              callback: function(value) {
                return '$' + value.toLocaleString();
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Department Categories',
              color: '#4a5568',
              font: { weight: 'bold' }
            }
          }
        }
      }
    });
  }

  // Update Purchase Probability Trends Chart
  const trendsContainer = document.getElementById('purchaseTrendsChart');
  if (trendsContainer) {
    console.log('Updating segment chart with real data:', topDepts);

    // Ensure we have valid data for each department
    const validDepts = topDepts.filter(p => {
      const hasBasicData = p.department && p.confidence !== undefined;
      const hasForecasts = p.forecasts && Object.keys(p.forecasts).length > 0;
      console.log(`Department ${p.department}: basic=${hasBasicData}, forecasts=${hasForecasts}`, p.forecasts);
      return hasBasicData && hasForecasts;
    });
    console.log(`Filtered ${validDepts.length} valid departments out of ${topDepts.length}`);

    // If no departments with forecasts, check if we have any departments at all
    if (validDepts.length === 0) {
      console.error('No valid department data for trends chart');
      console.log('Sample department data:', topDepts[0]);

      if (topDepts.length > 0) {
        // Show a message that forecasts are missing but departments exist
        document.getElementById('purchaseTrendsChart').innerHTML = `
          <div class="text-center py-5 text-warning">
            <i class="fas fa-chart-line fa-3x mb-3"></i>
            <h6>Missing Forecast Data</h6>
            <p>Departments found (${topDepts.length}) but missing time-based forecasts. Check ML model training.</p>
          </div>
        `;
      } else {
        document.getElementById('purchaseTrendsChart').innerHTML = `
          <div class="text-center py-5 text-danger">
            <i class="fas fa-database fa-3x mb-3"></i>
            <h6>No Department Data</h6>
            <p>No department predictions available from API.</p>
          </div>
        `;
      }
      return;
    }

    // Extract time-based forecast data with proper future predictions
    const timeLabels = ['1 Month', '3 Months', '6 Months', '12 Months'];
    const datasets = [];

    validDepts.slice(0, 4).forEach((dept, index) => {
      const forecasts = dept.forecasts || {};

      // Use actual future probability predictions from the new system
      const probabilities = [
        (forecasts['1_month']?.probability || 0) * 100,
        (forecasts['3_months']?.probability || 0) * 100,
        (forecasts['6_months']?.probability || 0) * 100,
        (forecasts['12_months']?.probability || 0) * 100
      ];

      const revenues = [
        forecasts['1_month']?.revenue_forecast || 0,
        forecasts['3_months']?.revenue_forecast || 0,
        forecasts['6_months']?.revenue_forecast || 0,
        forecasts['12_months']?.revenue_forecast || 0
      ];

      console.log(`Real forecast data - ${dept.department}:`, {
        '1_month': `${probabilities[0].toFixed(1)}% / $${revenues[0].toLocaleString()}`,
        '3_months': `${probabilities[1].toFixed(1)}% / $${revenues[1].toLocaleString()}`,
        '6_months': `${probabilities[2].toFixed(1)}% / $${revenues[2].toLocaleString()}`,
        '12_months': `${probabilities[3].toFixed(1)}% / $${revenues[3].toLocaleString()}`
      });

      const colors = ['#667eea', '#38a169', '#e53e3e', '#d69e2e'];
      const color = colors[index % colors.length];

      datasets.push({
        label: `${dept.department} Purchase Probability`,
        data: probabilities,
        borderColor: color,
        backgroundColor: color + '20',
        pointBackgroundColor: color,
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: color,
        borderWidth: 3,
        pointRadius: 6,
        tension: 0.4,
        yAxisID: 'y',
        revenues: revenues // Store revenue data for tooltips
      });
    });

    trendsContainer.innerHTML = `<canvas id="trendsChart" height="250"></canvas>`;
    const ctx2 = document.getElementById('trendsChart');

    if (charts.trends) charts.trends.destroy();
    charts.trends = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              padding: 15,
              usePointStyle: true,
              font: { weight: 'bold', size: 11 }
            }
          },
          title: {
            display: true,
            text: `${algorithm.replace('_', ' ').toUpperCase()} Model: Purchase Probability Over Time`,
            font: { size: 14, weight: 'bold' },
            color: '#2d3748'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}% probability`;
              },
              afterLabel: function(context) {
                const deptIndex = datasets.findIndex(d => d.label === context.dataset.label);
                const dept = validDepts[deptIndex];
                if (dept && dept.forecasts) {
                  // Map dataIndex to correct time keys (0=1_month, 1=3_months, 2=6_months, 3=12_months)
                  const timeKeys = ['1_month', '3_months', '6_months', '12_months'];
                  const timeKey = timeKeys[context.dataIndex];
                  const revenue = dept.forecasts[timeKey]?.revenue_forecast || 0;
                  return `Expected Revenue: $${revenue.toLocaleString()}`;
                }
                return '';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Purchase Probability (%)',
              color: '#4a5568',
              font: { weight: 'bold' }
            },
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Time Period',
              color: '#4a5568',
              font: { weight: 'bold' }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });

    console.log('Purchase probability trends chart created successfully');
  }
}

function generateTimeBasedInsights(predictions, algorithm) {
  console.log('Generating time-based insights for algorithm:', algorithm);
  console.log('Predictions data:', predictions);

  if (!predictions || predictions.length === 0) {
    console.error('No predictions available for insights generation');
    return;
  }

  // Find the container where insights will be displayed
  let insightsContainer = document.getElementById('timeBasedInsights');
  if (!insightsContainer) {
    // Create insights container if it doesn't exist
    const chartsContainer = document.querySelector('#predictive .row.g-4');
    if (chartsContainer) {
      const insightsDiv = document.createElement('div');
      insightsDiv.className = 'col-12';
      insightsDiv.innerHTML = `
        <div class="chart-container">
          <h5 class="mb-3"><i class="fas fa-clock"></i> Time-Based Forecast Insights</h5>
          <div id="timeBasedInsights"></div>
        </div>
      `;
      chartsContainer.appendChild(insightsDiv);
      insightsContainer = document.getElementById('timeBasedInsights');
    }
  }

  if (!insightsContainer) {
    console.error('Could not find or create insights container');
    return;
  }

  // Analyze top departments with forecasts
  const topDepts = predictions.slice(0, 4).filter(p => p.forecasts);

  if (topDepts.length === 0) {
    insightsContainer.innerHTML = `
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> No time-based forecast data available.
      </div>
    `;
    return;
  }

  // Generate insights based on forecast trends
  const insights = [];

  topDepts.forEach((dept, index) => {
    const forecasts = dept.forecasts;
    const month1 = forecasts['1_month'] || {};
    const month3 = forecasts['3_months'] || {};
    const year1 = forecasts['1_year'] || {};

    const probTrend = {
      short: (month1.probability || 0) * 100,
      medium: (month3.probability || 0) * 100,
      long: (year1.probability || 0) * 100
    };

    const revenueTrend = {
      short: month1.revenue_forecast || 0,
      medium: month3.revenue_forecast || 0,
      long: year1.revenue_forecast || 0
    };

    // Analyze trends
    let trendType = 'stable';
    let insight = '';
    let recommendation = '';

    if (probTrend.long > probTrend.medium && probTrend.medium > probTrend.short) {
      trendType = 'growing';
      insight = `${dept.department} shows strong growth potential with purchase probability increasing from ${probTrend.short.toFixed(1)}% to ${probTrend.long.toFixed(1)}% over the year.`;
      recommendation = `Increase inventory and marketing investment for ${dept.department} to capitalize on growth trend.`;
    } else if (probTrend.short > probTrend.medium && probTrend.medium > probTrend.long) {
      trendType = 'declining';
      insight = `${dept.department} shows declining trend with purchase probability dropping from ${probTrend.short.toFixed(1)}% to ${probTrend.long.toFixed(1)}% over the year.`;
      recommendation = `Review product mix and pricing strategy for ${dept.department} to address declining demand.`;
    } else {
      trendType = 'stable';
      insight = `${dept.department} maintains stable performance with consistent purchase probability around ${probTrend.medium.toFixed(1)}%.`;
      recommendation = `Maintain current strategy for ${dept.department} while exploring opportunities for growth.`;
    }

    insights.push({
      department: dept.department,
      type: trendType,
      insight: insight,
      recommendation: recommendation,
      forecasts: {
        probability: probTrend,
        revenue: revenueTrend
      }
    });
  });

  // Generate HTML for insights
  const insightsHtml = insights.map((insight, index) => {
    const iconMap = {
      growing: 'fas fa-arrow-trend-up text-success',
      declining: 'fas fa-arrow-trend-down text-danger',
      stable: 'fas fa-minus text-warning'
    };

    const colorMap = {
      growing: 'border-success',
      declining: 'border-danger',
      stable: 'border-warning'
    };

    return `
      <div class="col-md-6 mb-3">
        <div class="card ${colorMap[insight.type]} border-start border-3 h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <i class="${iconMap[insight.type]} me-2" style="font-size: 1.2rem;"></i>
              <h6 class="card-title mb-0">${insight.department} Department</h6>
            </div>
            <p class="card-text small text-muted mb-2">${insight.insight}</p>
            <div class="row g-2 mb-2">
              <div class="col-4">
                <small class="text-muted">1 Month</small><br>
                <strong>${insight.forecasts.probability.short.toFixed(1)}%</strong><br>
                <span class="text-success small">$${insight.forecasts.revenue.short.toLocaleString()}</span>
              </div>
              <div class="col-4">
                <small class="text-muted">3 Months</small><br>
                <strong>${insight.forecasts.probability.medium.toFixed(1)}%</strong><br>
                <span class="text-success small">$${insight.forecasts.revenue.medium.toLocaleString()}</span>
              </div>
              <div class="col-4">
                <small class="text-muted">1 Year</small><br>
                <strong>${insight.forecasts.probability.long.toFixed(1)}%</strong><br>
                <span class="text-success small">$${insight.forecasts.revenue.long.toLocaleString()}</span>
              </div>
            </div>
            <div class="alert alert-light small mb-0 py-2">
              <i class="fas fa-lightbulb text-warning me-1"></i>
              <strong>Recommendation:</strong> ${insight.recommendation}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  insightsContainer.innerHTML = `
    <div class="row">
      ${insightsHtml}
    </div>
    <div class="alert alert-info mt-3">
      <i class="fas fa-info-circle me-2"></i>
      <strong>${algorithm.replace('_', ' ').toUpperCase()} Model Forecasts:</strong>
      These predictions are based on real transaction data using the ${algorithm} algorithm.
      Probability percentages represent likelihood of customer purchases, while revenue forecasts
      estimate potential department performance over each time period.
    </div>
  `;

  console.log('Time-based insights generated successfully');
}

function updateAccuracyChart(performance) {
  const accuracyCtx = document.getElementById('accuracyChart');
  if (accuracyCtx && performance) {
    if (charts.accuracy) charts.accuracy.destroy();
    
    const models = Object.keys(performance);
    const accuracyData = models.map(model => (performance[model].accuracy * 100).toFixed(1));
    const precisionData = models.map(model => (performance[model].precision * 100).toFixed(1));
    const recallData = models.map(model => (performance[model].recall * 100).toFixed(1));
    
    charts.accuracy = new Chart(accuracyCtx, {
      type: 'bar',
      data: {
        labels: models.map(m => m.replace('_', ' ').toUpperCase()),
        datasets: [
          {
            label: 'Accuracy',
            data: accuracyData,
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 1
          },
          {
            label: 'Precision',
            data: precisionData,
            backgroundColor: 'rgba(118, 75, 162, 0.8)',
            borderColor: 'rgba(118, 75, 162, 1)',
            borderWidth: 1
          },
          {
            label: 'Recall',
            data: recallData,
            backgroundColor: 'rgba(39, 174, 96, 0.8)',
            borderColor: 'rgba(39, 174, 96, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        },
        plugins: {
          legend: {
            position: 'top'
          }
        }
      }
    });
  }
}
</script>

{% endblock %}
